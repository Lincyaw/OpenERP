#!/bin/sh

# Pre-commit hook: Run code checks before committing

echo "üîç Running pre-commit checks..."

# Get the list of staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
STAGED_FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^frontend/' || true)

# Track if we need to run E2E tests
RUN_E2E=false

# ============================================
# Backend checks (Go)
# ============================================
if [ -n "$STAGED_GO_FILES" ]; then
    echo ""
    echo "üì¶ Checking Go files..."
    RUN_E2E=false
    
    # Check formatting
    echo "  ‚Üí Checking Go formatting..."
    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)
    if [ -n "$UNFORMATTED" ]; then
        echo "‚ùå Go files are not formatted. Please run 'gofmt -w' on:"
        echo "$UNFORMATTED"
        exit 1
    fi
    
    # Run go vet
    echo "  ‚Üí Running go vet..."
    cd backend
    if ! go vet ./... 2>&1; then
        echo "‚ùå go vet found issues"
        exit 1
    fi
    cd ..
    
    # Note: go build check is skipped here as it will be done during docker build
    
    echo "‚úÖ Go checks passed"
fi

# ============================================
# Frontend checks (TypeScript/React)
# ============================================
if [ -n "$STAGED_FRONTEND_FILES" ]; then
    echo ""
    echo "üì¶ Checking frontend files..."
    RUN_E2E=false
    
    cd frontend

    # Run lint-staged for frontend (ESLint, Prettier, Stylelint)
    echo "  ‚Üí Running ESLint, Prettier, and Stylelint..."
    if ! npx lint-staged; then
        echo "‚ùå Frontend lint checks failed"
        exit 1
    fi

    if ! npm run build; then
        echo "‚ùå Frontend build failed"
        exit 1
    fi

    cd ..
    
    # Note: TypeScript build check is skipped here as it will be done during docker build
    
    echo "‚úÖ Frontend checks passed"
fi

# ============================================
# E2E Tests (only if backend or frontend changed)
# ============================================
if [ "$RUN_E2E" = true ]; then
    echo ""
    echo "üß™ Running E2E tests..."

    # Clean up old test results to avoid permission issues
    echo "  ‚Üí Cleaning up old test results..."
    rm -rf frontend/test-results frontend/playwright-report frontend/tests/e2e/.auth/user.json 2>/dev/null || true

    # Start test environment
    echo "  ‚Üí Starting test environment..."
    docker compose -f docker-compose.test.yml down -v 2>/dev/null || true
    docker compose -f docker-compose.test.yml up -d
    
    # Wait for services to be healthy
    echo "  ‚Üí Waiting for services to be ready..."
    MAX_WAIT=120
    WAITED=0
    while [ $WAITED -lt $MAX_WAIT ]; do
        if curl -sf http://localhost:8081/health > /dev/null 2>&1; then
            echo "  ‚Üí Backend is ready"
            break
        fi
        sleep 2
        WAITED=$((WAITED + 2))
        echo "  ‚Üí Waiting for backend... (${WAITED}s)"
    done

    if [ $WAITED -ge $MAX_WAIT ]; then
        echo "‚ùå Timeout waiting for backend to start"
        docker compose -f docker-compose.test.yml down -v
        exit 1
    fi

    # Give frontend a moment to be ready
    sleep 3

    # Load seed data using local-test.sh
    echo "  ‚Üí Loading seed data..."
    ./docker/local-test.sh seed || {
        echo "‚ùå Failed to load seed data"
        docker compose -f docker-compose.test.yml down -v
        exit 1
    }
    
    # Run E2E tests in Docker container (as current user to avoid permission issues)
    echo "  ‚Üí Running Playwright E2E tests in Docker..."
    E2E_RESULT=0
    docker compose -f docker-compose.test.yml run --rm \
        --user "$(id -u):$(id -g)" \
        -e HOME=/tmp \
        -e E2E_BASE_URL=http://frontend:80 \
        playwright npx playwright test --reporter=list || E2E_RESULT=$?
    
    # Stop test environment
    echo "  ‚Üí Stopping test environment..."
    docker compose -f docker-compose.test.yml down -v
    
    if [ $E2E_RESULT -ne 0 ]; then
        echo "‚ùå E2E tests failed"
        exit 1
    fi
    
    echo "‚úÖ E2E tests passed"
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
