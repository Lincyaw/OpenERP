# =============================================================================
# ERP Backend Configuration
# =============================================================================
# This is the default configuration. Environment-specific overrides:
#   - config.dev.toml (development)
#   - config.test.toml (testing)
#   - config.prod.toml (production)
#
# Environment variables can override any setting using the prefix "ERP_"
# Example: ERP_DATABASE_PASSWORD=xxx overrides [database] password
# =============================================================================

[app]
name = "erp-backend"
port = "8080"

[database]
host = "localhost"
port = 5432
user = "postgres"
password = "admin123"
dbname = "erp_dev"
sslmode = "disable"
max_open_conns = 25
max_idle_conns = 5
conn_max_lifetime = 60  # minutes
conn_max_idle_time = 30 # minutes

[redis]
host = "localhost"
port = 6379
password = ""
db = 0

[jwt]
secret = ""
access_token_expiration = "15m"
refresh_token_expiration = "168h"
issuer = "erp-backend"
refresh_secret = ""
max_refresh_count = 10

[cookie]
# Domain for cookies (empty = current domain)
# For development with proxy, explicitly set to the IP/hostname
domain = "10.10.10.146"
# Path for cookies
path = "/"
# Secure flag (should be true in production for HTTPS)
secure = false
# SameSite policy: "strict", "lax", or "none"
same_site = "lax"

[log]
level = "info"
format = "console"
output = "stdout"

[event]
processor_enabled = true
batch_size = 100
poll_interval = "5s"
max_retries = 5
cleanup_enabled = true
cleanup_retention = "168h"

[http]
read_timeout = "15s"
write_timeout = "15s"
idle_timeout = "60s"
max_header_bytes = 1048576    # 1MB
max_body_size = 10485760      # 10MB
rate_limit_enabled = true
rate_limit_requests = 100000
rate_limit_window = "1m"
# Auth rate limiting - stricter limits for authentication endpoints (SEC-008)
# Note: Higher limits for E2E testing (50/min), production should use 5/min
auth_rate_limit_enabled = true
auth_rate_limit_requests = 5000   # Higher for E2E tests, use 5 in production
auth_rate_limit_window = "1m"   # 1 minute window
# For cookie-based auth with credentials, use specific origins (not "*")
# In production, set to your actual frontend origin
cors_allow_origins = ["http://localhost:3000", "http://127.0.0.1:3000", "http://10.10.10.146:3000"]
cors_allow_methods = ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
cors_allow_headers = ["Content-Type", "Authorization", "X-Request-ID", "X-Tenant-ID"]
# SECURITY: If behind a reverse proxy/load balancer, set trusted_proxies to
# prevent IP spoofing attacks on the rate limiter. Empty = trust only RemoteAddr.
# Example for internal network: trusted_proxies = ["10.0.0.0/8", "172.16.0.0/12"]
trusted_proxies = []

[scheduler]
enabled = true
daily_cron_schedule = "0 2 * * *"  # 2am daily
max_concurrent_jobs = 3
job_timeout = "30m"
retry_attempts = 3
retry_delay = "5m"

[stock_lock]
# Stock lock expiration check interval
check_interval = "5m"
# Default lock expiration duration (24 hours as per spec)
default_expiration = "24h"
# Enable automatic expiration cleanup
auto_release_enabled = true

[swagger]
# Enable Swagger documentation endpoint (default: true in dev, false in production)
enabled = true
# Require authentication to access Swagger (only applies when enabled=true in production)
require_auth = false
# Allowed IP addresses (empty = allow all). Use this for IP-based restriction in production.
# Example: ["127.0.0.1", "10.0.0.0/8", "192.168.0.0/16"]
allowed_ips = []

[telemetry]
# Enable OpenTelemetry tracing and metrics
enabled = true
# OTEL Collector gRPC endpoint
collector_endpoint = "otel-collector:14317"
# Sampling ratio (0.0-1.0, 1.0 = 100% of traces)
# Development: 1.0 (all traces), Production: consider 0.1-0.5 depending on traffic
sampling_ratio = 1.0
# Service name for traces (used in Jaeger, Zipkin, etc.)
service_name = "erp-backend"
# Use insecure (non-TLS) connection to collector
# Set to true for local development, false for production (TLS required)
insecure = true
# Metrics export interval (how often metrics are sent to collector)
# Default: 60s, lower values = more frequent exports but higher overhead
metrics_export_interval = "60s"

# Logs bridge (Zap -> OTEL)
# Enable exporting Zap logs to OTEL Collector
# When enabled, logs are output to both stdout and OTEL Collector
logs_enabled = true

# Database tracing options (otelgorm)
# Enable database query tracing
db_trace_enabled = true
# Log full SQL statements including query parameters
# WARNING: MUST be false in production to avoid exposing sensitive data in traces
# Only enable in development for debugging purposes
db_log_full_sql = false
# Slow query threshold - queries exceeding this duration are marked as slow
# Default: 200ms, adjust based on your performance requirements
db_slow_query_threshold = "200ms"

# Pyroscope continuous profiling configuration
[telemetry.profiling]
# Enable continuous profiling (default: false)
# When enabled, profiles are sent to Pyroscope server for analysis
enabled = false
# Pyroscope server address (default: http://pyroscope:4040)
server_address = "http://pyroscope:4040"
# Application name for profiles (default: uses telemetry.service_name)
application_name = "erp-backend"
# Optional: Grafana Cloud authentication (leave empty for self-hosted Pyroscope)
# basic_auth_user = ""
# basic_auth_password = ""

# Profile types to enable (all default to true when profiling.enabled=true)
# CPU profiling - identifies CPU-intensive code paths
profile_cpu = true
# Allocation profiling - tracks memory allocations
profile_alloc_objects = true
profile_alloc_space = true
# In-use memory profiling - tracks live memory
profile_inuse_objects = true
profile_inuse_space = true
# Goroutine profiling - tracks goroutine creation
profile_goroutines = true

# Advanced profile types (default: false, requires runtime configuration)
# Mutex profiling - tracks mutex contention
profile_mutex_count = false
profile_mutex_duration = false
# Block profiling - tracks blocking operations
profile_block_count = false
profile_block_duration = false

# Advanced options
# Mutex profile fraction (default: 5, only used when mutex profiling is enabled)
mutex_profile_fraction = 5
# Block profile rate (default: 5, only used when block profiling is enabled)
block_profile_rate = 5
# Disable GC runs in profiler (improves CPU profile accuracy, reduces heap precision)
disable_gc_runs = false

# Span Profiles integration with OpenTelemetry (requires telemetry.enabled=true)
# When enabled, each OTel span automatically gets associated CPU profile data
# This allows jumping from a trace span directly to its CPU profile in Pyroscope
# Requires Pyroscope server >= 0.14.0
# NOTE: Only CPU profiling is supported for span profiles
# NOTE: Go CPU profiler samples at 100Hz, spans shorter than 10ms may not have profile data
span_profiles_enabled = true

# =============================================================================
# Object Storage Configuration (RustFS / S3-compatible)
# =============================================================================
# For file attachments (product images, documents, etc.)
# Uses RustFS (S3-compatible) in development, can use AWS S3 or other S3-compatible
# storage in production.
[storage]
# S3-compatible endpoint URL (without protocol for SDK auto-detection)
# Development: http://localhost:9000 (RustFS)
# Production: s3.amazonaws.com or your S3-compatible endpoint
endpoint = "http://localhost:9000"

# AWS region (required even for non-AWS S3-compatible storage)
region = "us-east-1"

# Access credentials
# SECURITY: Use environment variables in production: ERP_STORAGE_ACCESS_KEY
access_key = "rustfsadmin"
# SECURITY: Use environment variables in production: ERP_STORAGE_SECRET_KEY
secret_key = "rustfsadmin123"

# Default bucket for file attachments
# This bucket will be auto-created on startup if it doesn't exist
bucket = "erp-attachments"

# Use path-style URLs instead of virtual-hosted style
# Required for RustFS and most S3-compatible storage (MinIO, etc.)
# Set to false for AWS S3 in production
use_path_style = true

# Enable SSL/TLS for S3 connections
# Development: false (RustFS without TLS)
# Production: true (AWS S3 or TLS-enabled storage)
use_ssl = false

# Presigned URL expiration time for uploads and downloads
presign_expiration = "15m"

# Maximum file size for uploads (in bytes)
# Default: 50MB
max_file_size = 52428800

# Allowed MIME types for uploads (empty = allow all)
# Example: ["image/jpeg", "image/png", "image/gif", "application/pdf"]
allowed_mime_types = [
  "image/jpeg",
  "image/png",
  "image/gif",
  "image/webp",
  "application/pdf",
  "application/msword",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
]
