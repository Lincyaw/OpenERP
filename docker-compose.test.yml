# Test environment - runs on different ports to avoid conflicts with dev/prod
# Frontend: 3001, Backend: 8081, PostgreSQL: 5433, Redis: 6380

services:
  # PostgreSQL Database for Testing
  postgres:
    image: postgres:18.1
    container_name: erp-test-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: erp_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: test123
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - test_postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - erp-test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d erp_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Cache for Testing
  redis:
    image: redis:8.4.0
    container_name: erp-test-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6380:6379"
    volumes:
      - test_redis_data:/data
    networks:
      - erp-test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Backend API for Testing
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: erp-test-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Application
      APP_NAME: erp-test
      APP_ENV: test
      APP_PORT: 8080

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: test123
      DB_NAME: erp_test
      DB_SSL_MODE: disable
      DB_MAX_OPEN_CONNS: 10
      DB_MAX_IDLE_CONNS: 2
      DB_CONN_MAX_LIFETIME: 30
      DB_CONN_MAX_IDLE_TIME: 15

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      REDIS_DB: 0

      # JWT
      JWT_SECRET: test-secret-key-not-for-production
      JWT_ACCESS_TOKEN_EXPIRATION: 24h
      JWT_REFRESH_TOKEN_EXPIRATION: 168h
      JWT_ISSUER: erp-test
      JWT_MAX_REFRESH_COUNT: 10

      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: console
      LOG_OUTPUT: stdout

      # HTTP Server
      HTTP_READ_TIMEOUT: 30s
      HTTP_WRITE_TIMEOUT: 30s
      HTTP_IDLE_TIMEOUT: 120s
      HTTP_MAX_HEADER_BYTES: 1048576
      HTTP_MAX_BODY_SIZE: 10485760
      HTTP_RATE_LIMIT_ENABLED: false
      HTTP_CORS_ORIGINS: "*"
      HTTP_CORS_METHODS: GET,POST,PUT,DELETE,PATCH,OPTIONS
      HTTP_CORS_HEADERS: Content-Type,Authorization,X-Request-ID,X-Tenant-ID

      # Event Processing
      EVENT_PROCESSOR_ENABLED: true
      EVENT_PROCESSOR_BATCH_SIZE: 50
      EVENT_PROCESSOR_INTERVAL: 2s
      EVENT_MAX_RETRIES: 3
      EVENT_CLEANUP_ENABLED: false
    ports:
      - "8081:8080"
    networks:
      - erp-test-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Database Migration Runner
  migrate:
    image: migrate/migrate:v4.17.0
    container_name: erp-test-migrate
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend/migrations:/migrations:ro
    networks:
      - erp-test-network
    command: >
      -path=/migrations
      -database "postgres://postgres:test123@postgres:5432/erp_test?sslmode=disable"
      up
    restart: on-failure

  # Frontend Web App for Testing
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: erp-test-frontend
    restart: unless-stopped
    user: "1000:1000"
    depends_on:
      - backend
    environment:
      VITE_API_BASE_URL: /api/v1
      VITE_APP_NAME: ERP Test
      VITE_APP_VERSION: test
    ports:
      - "3001:80"
    networks:
      - erp-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Playwright E2E Test Runner
  playwright:
    image: mcr.microsoft.com/playwright:v1.58.0-noble
    container_name: erp-test-playwright
    user: "1000:1000"
    working_dir: /app
    depends_on:
      - frontend
      - backend
    environment:
      E2E_BASE_URL: http://frontend:80
      CI: "true"
      HOME: /tmp
    volumes:
      - ./frontend:/app
    networks:
      - erp-test-network
    command: ["npx", "playwright", "test", "--reporter=list"]
    profiles:
      - e2e

networks:
  erp-test-network:
    driver: bridge
    name: erp-test-network

volumes:
  test_postgres_data:
    name: erp-test-postgres-data
  test_redis_data:
    name: erp-test-redis-data
