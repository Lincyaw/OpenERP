## 2026-01-24: P3-BE-006 - SalesOrder Event Processing (Stock Locking)

### Completed Feature
Implemented sales order event handlers for inventory integration via domain events.

### Files Created
- `backend/internal/application/trade/sales_order_confirmed_handler.go`
  - Handles SalesOrderConfirmedEvent to lock stock when order is confirmed
  - Iterates through order items and locks stock for each product in the warehouse
  - Uses 30-minute default lock expiration

- `backend/internal/application/trade/sales_order_shipped_handler.go`
  - Handles SalesOrderShippedEvent to deduct locked stock when order is shipped
  - Retrieves locks by source and maps productID to lockID for deduction
  - Continues processing other items even if some fail

- `backend/internal/application/trade/sales_order_cancelled_handler.go`
  - Handles SalesOrderCancelledEvent to release stock locks when order is cancelled
  - Only releases locks if order WasConfirmed (draft orders have no locks)
  - Uses UnlockBySource for bulk unlock

- `backend/internal/application/trade/sales_order_event_handlers_test.go`
  - Comprehensive unit tests for all three handlers (18+ test cases)
  - Tests for EventTypes, Success, MissingWarehouse, WrongEventType, PartialFailure

### Files Modified
- `backend/internal/application/trade/sales_order_service.go`
  - Added eventPublisher field and SetEventPublisher method
  - Confirm method now publishes SalesOrderConfirmedEvent
  - Ship method now publishes SalesOrderShippedEvent
  - Cancel method now publishes SalesOrderCancelledEvent

- `backend/internal/application/inventory/inventory_service.go`
  - Added GetLocksBySource method with ProductID/WarehouseID enrichment
  - Added UnlockBySource method for bulk unlock by source

- `backend/internal/application/inventory/dto.go`
  - Added WarehouseID and ProductID fields to StockLockResponse

- `backend/cmd/server/main.go`
  - Registered SalesOrderConfirmedHandler
  - Registered SalesOrderShippedHandler
  - Registered SalesOrderCancelledHandler
  - Injected event publisher into SalesOrderService

### Event Flow
1. Order Confirmed -> SalesOrderConfirmedEvent -> Lock stock for each item
2. Order Shipped -> SalesOrderShippedEvent -> Deduct locked stock
3. Order Cancelled (if was confirmed) -> SalesOrderCancelledEvent -> Release stock locks

### Tests
All tests pass (`go test ./...`)

## 2026-01-24: P1-BE-016, P1-BE-017, P1-BE-018 - Customer Balance Transaction Feature

### Completed Features
Implemented complete customer balance transaction tracking system with API endpoints.

### Files Created
- `backend/internal/domain/partner/balance_transaction.go`
  - BalanceTransaction entity with transaction types (RECHARGE, CONSUME, REFUND, ADJUSTMENT, EXPIRE)
  - BalanceTransactionSourceType (MANUAL, SALES_ORDER, SALES_RETURN, RECEIPT_VOUCHER, SYSTEM)
  - Factory functions: CreateRechargeTransaction, CreateConsumeTransaction, CreateRefundTransaction, CreateAdjustmentTransaction
  - Helper methods: GetSignedAmount, IsIncrease, IsDecrease, BalanceChange

- `backend/internal/domain/partner/balance_transaction_repository.go`
  - BalanceTransactionRepository interface with CRUD and query methods
  - BalanceTransactionFilter for pagination and filtering

- `backend/migrations/000016_create_balance_transactions.up.sql`
  - Creates balance_transactions table with proper indexes
  - Constraints for transaction types, source types, and amount validation

- `backend/migrations/000016_create_balance_transactions.down.sql`
  - Rollback migration

- `backend/internal/infrastructure/persistence/balance_transaction_repository.go`
  - GORM implementation of BalanceTransactionRepository
  - Supports filtering by customer, type, source, date range
  - Implements SumByCustomerIDAndType for summary queries

- `backend/internal/application/partner/balance_transaction_service.go`
  - Application service with Recharge, Consume, Refund, Adjust operations
  - GetByID, ListByCustomer, GetBalanceSummary, GetBalance, HasSufficientBalance

- `backend/internal/interfaces/http/handler/balance_transaction.go`
  - HTTP handler with Swagger annotations for all endpoints
  - POST /customers/:customerId/balance/recharge
  - POST /customers/:customerId/balance/adjust
  - GET /customers/:customerId/balance
  - GET /customers/:customerId/balance/summary
  - GET /customers/:customerId/balance/transactions
  - GET /balance/transactions/:id

### Files Modified
- `backend/internal/application/partner/dto.go`
  - Added BalanceTransaction DTOs: RechargeBalanceRequest, AdjustBalanceRequest
  - Added BalanceTransactionResponse, BalanceTransactionListFilter, BalanceSummaryResponse
  - Added converter functions: ToBalanceTransactionResponse, ToBalanceTransactionResponses

- `backend/cmd/server/main.go`
  - Registered BalanceTransactionRepository
  - Registered BalanceTransactionService
  - Registered BalanceTransactionHandler with routes under /partner

### API Endpoints
| Method | Path | Description |
|--------|------|-------------|
| POST | /partner/customers/:customerId/balance/recharge | Recharge customer balance |
| POST | /partner/customers/:customerId/balance/adjust | Adjust customer balance (increase/decrease) |
| GET | /partner/customers/:customerId/balance | Get current balance |
| GET | /partner/customers/:customerId/balance/summary | Get balance summary (totals) |
| GET | /partner/customers/:customerId/balance/transactions | List balance transactions |
| GET | /partner/balance/transactions/:id | Get transaction by ID |

### OpenAPI & SDK
- Regenerated OpenAPI spec with `swag init`
- Regenerated frontend TypeScript SDK with `npm run api:generate`

### Tests
Backend builds successfully (`go build ./cmd/server/main.go`)
