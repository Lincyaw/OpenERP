# ERP Development Progress

## 2026-01-23 - P0-BE-001: Backend Scaffolding Complete

### Completed
- **P0-BE-001**: 项目脚手架搭建 (Go Module, 目录结构)

### What was done
1. Created Go module at `backend/` with `github.com/erp/backend`
2. Established DDD directory structure:
   - `cmd/server/` - HTTP server entry point
   - `internal/domain/` - Domain layer with bounded contexts (catalog, partner, inventory, trade, finance, shared)
   - `internal/application/` - Application services (placeholder)
   - `internal/infrastructure/` - Infrastructure (config, persistence, eventbus)
   - `internal/interfaces/http/` - HTTP handlers, DTOs, middleware
   - `migrations/` - Database migrations (empty, ready for P0-BE-004)
   - `tests/` - Unit and integration test directories

3. Installed dependencies:
   - gin-gonic/gin (HTTP framework)
   - gorm.io/gorm + postgres driver (ORM)
   - google/uuid (UUIDs)
   - shopspring/decimal (precise decimals)
   - go-playground/validator/v10 (validation)
   - uber/zap (logging, not yet configured)
   - spf13/viper (config, not yet integrated)
   - golang-jwt/jwt/v5 (authentication)
   - redis/go-redis/v9 (cache/queue)
   - testify (testing)

4. Created shared domain components:
   - `BaseEntity` and `BaseAggregateRoot` with version for optimistic locking
   - `TenantAggregateRoot` for multi-tenant support
   - `DomainEvent` interface and `BaseDomainEvent`
   - `Repository` generic interface with `Filter` and `Paginated` types
   - Common domain errors (NotFound, AlreadyExists, InvalidState, etc.)

5. Created HTTP infrastructure:
   - Unified response format (`dto/response.go`)
   - Base handler with error handling (`handler/base.go`)
   - Common middleware (CORS, RequestID, Logger)
   - Health check and ping endpoints

### Files created
- `backend/go.mod`, `backend/go.sum`
- `backend/cmd/server/main.go`
- `backend/internal/domain/shared/*.go` (5 files)
- `backend/internal/domain/{catalog,partner,inventory,trade,finance}/doc.go`
- `backend/internal/infrastructure/config/config.go`
- `backend/internal/interfaces/http/dto/response.go`
- `backend/internal/interfaces/http/handler/base.go`
- `backend/internal/interfaces/http/middleware/common.go`
- `backend/README.md`, `.gitignore`, `.env.example`

### Build Status
- `go build ./...` passes successfully

### Notes for next developer
- P0-BE-002 (Database connection) depends on this and can now be started
- P0-BE-003 (Logger config) depends on this and can now be started
- Config currently uses env vars directly; may integrate Viper in P0-BE-003
- Main server is functional but minimal - add routes as APIs are developed
- Shared kernel is ready for value objects (P0-BE-005)

---

## 2026-01-23 - P0-BE-002: Database Connection Configuration Complete

### Completed
- **P0-BE-002**: 数据库连接配置 (PostgreSQL)

### What was done
1. Created database connection module at `internal/infrastructure/persistence/database.go`:
   - `Database` struct wrapping GORM DB instance
   - `NewDatabase()` and `NewDatabaseWithLogger()` constructors
   - Connection pool configuration (MaxOpenConns, MaxIdleConns, ConnMaxLifetime, ConnMaxIdleTime)
   - `Close()`, `Ping()`, `Stats()` methods for connection management
   - `Transaction()` method for transactional operations
   - `WithTenant()` method for multi-tenant scoping (with empty tenant ID validation)

2. Enhanced configuration with validation:
   - Added `ConnMaxLifetime` and `ConnMaxIdleTime` config options
   - Added production-specific validation (JWT secret, DB password, SSL mode)
   - Added connection pool validation (MaxIdleConns <= MaxOpenConns)
   - Changed DSN format to URL-style for proper escaping of special characters

3. Integrated database into main server:
   - Database connection on startup with graceful close on shutdown
   - Health check endpoint now returns proper HTTP 503 when database is unhealthy
   - Database status included in health response

4. Security improvements:
   - Production requires JWT secret (min 32 chars), DB password, and SSL enabled
   - Empty tenant ID in `WithTenant()` panics to prevent data leakage
   - DSN uses URL encoding to handle special characters in passwords

5. Test coverage:
   - Unit tests for `Database` struct methods using sqlmock
   - Tests for `ConnectionStats` struct
   - Tests for `WithTenant` including SQL injection prevention
   - Tests for `Transaction` with commit and rollback scenarios
   - Config validation tests for both development and production modes
   - DSN generation tests including special character escaping

### Files created/modified
- `backend/internal/infrastructure/persistence/database.go` (new)
- `backend/internal/infrastructure/persistence/database_test.go` (new)
- `backend/internal/infrastructure/config/config.go` (enhanced with validation)
- `backend/internal/infrastructure/config/config_test.go` (new)
- `backend/cmd/server/main.go` (integrated database)
- `backend/.env.example` (added new config options)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Notes for next developer
- P0-BE-003 (Logger config) can now be started - integrate zap with database logging
- P0-BE-004 (Database migrations) can now be started - database connection is ready
- The `NewDatabaseWithLogger()` function allows custom log levels for debugging
- `WithTenant()` requires non-empty tenant ID - use in middleware after auth
- For integration tests, use testcontainers-go to spin up PostgreSQL
- Health endpoint at `/health` includes database status

---

## 2026-01-23 - P0-BE-003: Logger Framework Configuration Complete

### Completed
- **P0-BE-003**: 日志框架配置

### What was done
1. Created logger package at `internal/infrastructure/logger/` with 4 files:
   - `logger.go` - Core logger initialization with zap, supports different levels (debug/info/warn/error) and formats (json/console)
   - `context.go` - Context helpers for request ID, tenant ID, user ID correlation
   - `gin.go` - Gin middleware for HTTP request logging and panic recovery
   - `gorm.go` - GORM logger adapter that integrates database queries with zap

2. Logger features implemented:
   - Environment-aware logging (development uses console format with colors, production uses JSON)
   - Structured logging with zap fields
   - Request correlation with request_id, tenant_id, user_id
   - HTTP request logging middleware with latency, status codes, client IP, user agent
   - Panic recovery middleware with stack traces
   - GORM query logging with slow query detection (200ms threshold)
   - Log level filtering at both application and database level

3. Configuration added:
   - `LOG_LEVEL` - Log level (debug, info, warn, error)
   - `LOG_FORMAT` - Output format (json, console)
   - `LOG_OUTPUT` - Output destination (stdout, stderr, or file path)

4. Integration completed:
   - Main server uses zap instead of stdlib log
   - Database uses custom GORM logger backed by zap
   - HTTP middleware stack updated: RequestID → Recovery → Logger → CORS
   - Health endpoint now logs warnings on failure

5. Test coverage:
   - 60 unit tests covering all logger functionality
   - Tests for level parsing, encoding, context propagation
   - Tests for Gin middleware (success/error/panic scenarios)
   - Tests for GORM logger (info/warn/error/trace/slow query)

### Files created/modified
- `backend/internal/infrastructure/logger/logger.go` (new)
- `backend/internal/infrastructure/logger/context.go` (new)
- `backend/internal/infrastructure/logger/gin.go` (new)
- `backend/internal/infrastructure/logger/gorm.go` (new)
- `backend/internal/infrastructure/logger/logger_test.go` (new)
- `backend/internal/infrastructure/logger/context_test.go` (new)
- `backend/internal/infrastructure/logger/gin_test.go` (new)
- `backend/internal/infrastructure/logger/gorm_test.go` (new)
- `backend/internal/infrastructure/config/config.go` (added LogConfig)
- `backend/internal/infrastructure/persistence/database.go` (added NewDatabaseWithCustomLogger)
- `backend/cmd/server/main.go` (integrated zap logging)
- `backend/.env.example` (added LOG_* variables)
- `backend/go.mod` (added zap dependency)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (60 new tests in logger package)

### Notes for next developer
- P0-BE-004 (Database migrations) can now be started - logger available for migration output
- P0-BE-008 (HTTP framework) is partially done - Gin middleware stack is configured with logging
- Use `logger.GetGinLogger(c)` in HTTP handlers to get request-scoped logger
- Use `logger.FromContext(ctx)` in application services to get context logger
- GORM logs SQL queries at DEBUG level, slow queries (>200ms) at WARN level
- Production mode uses JSON format with ISO8601 timestamps
- Set LOG_LEVEL=debug to see SQL queries in development

---

## 2026-01-23 - P0-BE-004: Database Migration Tool Configuration Complete

### Completed
- **P0-BE-004**: 数据库迁移工具配置 (golang-migrate)

### What was done
1. Integrated golang-migrate library:
   - Added `github.com/golang-migrate/migrate/v4` dependency
   - Added `github.com/lib/pq` for native PostgreSQL driver support in CLI

2. Created migration infrastructure at `internal/infrastructure/migration/`:
   - `migrate.go` - Core Migrator struct wrapping golang-migrate
     - `New()` and `NewFromURL()` constructors
     - `Up()`, `Down()`, `Steps()`, `GoTo()` migration methods
     - `Version()`, `Force()`, `Drop()` utility methods
     - Integrated with zap logger for structured logging
   - `creator.go` - Migration file creation utilities
     - `CreateMigration()` creates up/down SQL file pairs
     - Template-based migration file generation
     - Version format: YYYYMMDDHHMMSS for proper ordering
     - `ListMigrations()` to enumerate available migrations

3. Created migration CLI at `cmd/migrate/`:
   - Full-featured CLI for database migrations
   - Commands: up, down, step, goto, version, force, drop, create, list
   - Configurable migrations path and log level
   - Uses same database config as main server
   - Safety features: drop requires `-confirm` flag

4. Created initial migration:
   - `migrations/000001_init_schema.up.sql`:
     - Enables uuid-ossp and pgcrypto extensions
     - Creates tenants table with multi-tenancy support
     - Implements `update_updated_at_column()` trigger function
     - Adds default tenant for development
   - `migrations/000001_init_schema.down.sql`:
     - Clean rollback of all schema changes

5. Test coverage:
   - Unit tests for migration creator functions
   - Tests for name sanitization
   - Tests for file creation and directory handling
   - Tests for migration listing

### Files created/modified
- `backend/internal/infrastructure/migration/migrate.go` (new)
- `backend/internal/infrastructure/migration/creator.go` (new)
- `backend/internal/infrastructure/migration/creator_test.go` (new)
- `backend/cmd/migrate/main.go` (new)
- `backend/migrations/000001_init_schema.up.sql` (new)
- `backend/migrations/000001_init_schema.down.sql` (new)
- `backend/README.md` (updated with migration documentation)
- `backend/.env.example` (added MIGRATIONS_PATH)
- `backend/go.mod` (added golang-migrate and pq dependencies)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Usage Examples
```bash
# Build the migration CLI
go build -o bin/migrate cmd/migrate/main.go

# Apply all pending migrations
./bin/migrate up

# Create a new migration
./bin/migrate create add_users_table "Create users table"

# Check current version
./bin/migrate version

# Roll back last migration
./bin/migrate step -1
```

### Notes for next developer
- P0-BE-005 (Value objects) can now be started - migrations are ready for new tables
- P0-BE-006 (Event bus) can now be started - database foundation is complete
- Initial migration creates tenants table for multi-tenancy
- Use `./bin/migrate create <name>` to add new migrations
- Migrations use YYYYMMDDHHMMSS versioning for proper ordering
- The Migrator integrates with zap logger for structured output
- Force command should only be used to fix dirty state
- Drop command is destructive and requires explicit confirmation

---

## 2026-01-23 - P0-BE-005: Common Value Objects Complete

### Completed
- **P0-BE-005**: 通用值对象实现 (Money, Quantity)

### What was done
1. Added shopspring/decimal dependency for precise decimal arithmetic:
   - `github.com/shopspring/decimal v1.4.0`

2. Implemented Money value object at `internal/domain/shared/valueobject/money.go`:
   - Immutable design - all operations return new instances
   - Multiple currency support (CNY, USD, EUR, GBP, JPY, HKD)
   - Factory methods: `NewMoney()`, `NewMoneyFromFloat()`, `NewMoneyFromInt()`, `NewMoneyFromString()`
   - CNY-specific helpers: `NewMoneyCNY()`, `NewMoneyCNYFromFloat()`, `ZeroCNY()`
   - Arithmetic: `Add()`, `Subtract()`, `Multiply()`, `Divide()`, `Negate()`, `Abs()`
   - Comparisons: `Equals()`, `LessThan()`, `GreaterThan()`, `LessThanOrEqual()`, `GreaterThanOrEqual()`
   - Rounding: `Round()`, `RoundBank()`, `Truncate()`
   - Business operations: `Allocate()` (fair division), `CalculatePercentage()`, `ApplyDiscount()`
   - JSON serialization: `MarshalJSON()`, `UnmarshalJSON()`
   - Database support: `Value()` (driver.Valuer), `Scan()` (sql.Scanner)

3. Implemented Quantity value object at `internal/domain/shared/valueobject/quantity.go`:
   - Immutable design - all operations return new instances
   - Non-negative enforcement (prevents negative inventory)
   - Unit of measurement support
   - Factory methods: `NewQuantity()`, `NewQuantityFromFloat()`, `NewQuantityFromInt()`, `NewIntegerQuantity()`
   - Arithmetic: `Add()`, `Subtract()`, `Multiply()`, `Divide()`
   - Unit conversion: `Convert()`, `ConvertByFloat()`
   - Rounding: `Round()`, `Truncate()`, `Ceiling()`, `Floor()`
   - Inventory helpers: `SufficientFor()`, `Deficit()`, `Split()`
   - Allows negative with `SubtractAllowNegative()` for deficit calculation
   - JSON and database support

4. Comprehensive unit tests:
   - `money_test.go`: 27 test cases covering all Money functionality
   - `quantity_test.go`: 25 test cases covering all Quantity functionality
   - Test coverage: 86.3% of statements

### Files created/modified
- `backend/internal/domain/shared/valueobject/money.go` (new)
- `backend/internal/domain/shared/valueobject/money_test.go` (new)
- `backend/internal/domain/shared/valueobject/quantity.go` (new)
- `backend/internal/domain/shared/valueobject/quantity_test.go` (new)
- `backend/go.mod` (added shopspring/decimal)
- `backend/go.sum` (updated)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (86.3% coverage for valueobject package)

### Key Design Decisions
1. **Immutability**: All methods return new instances to prevent accidental mutation
2. **Currency safety**: Money operations fail if currencies don't match
3. **Non-negative Quantity**: Standard subtract fails if result would be negative; use `SubtractAllowNegative()` for deficit calculation
4. **Decimal precision**: Uses shopspring/decimal for financial calculations (no floating-point errors)
5. **Database storage**: Values stored as strings to preserve precision

### Usage Examples
```go
// Money
price := NewMoneyCNYFromFloat(99.99)
quantity := 3
total := price.MultiplyByInt(quantity) // 299.97 CNY

discount := total.ApplyDiscount(decimal.NewFromInt(10)) // 10% off
parts, _ := total.Allocate(3) // Fair division for split payments

// Quantity
stock, _ := NewQuantityFromInt(100, "pcs")
ordered, _ := NewQuantityFromInt(30, "pcs")
remaining, _ := stock.Subtract(ordered) // 70 pcs

sufficient, _ := stock.SufficientFor(ordered) // true
deficit, _ := ordered.Deficit(stock) // 0 pcs (no deficit)

// Unit conversion (1000g = 1kg)
grams, _ := NewQuantityFromInt(1000, "g")
kg, _ := grams.Convert("kg", decimal.NewFromFloat(0.001)) // 1 kg
```

### Notes for next developer
- P0-BE-006 (Event bus) can now be started - value objects ready
- P0-BE-008 (HTTP framework) is partially done from P0-BE-003
- Money uses `DefaultCurrency = CNY` when scanning from database without currency
- For multi-currency systems, store currency alongside amount in database
- Use `MustAdd()` / `MustSubtract()` when you're certain units/currencies match (panics on mismatch)
- Quantity's `Convert()` is for unit conversion, not currency conversion

---

## 2026-01-23 - P0-BE-006: Domain Event Infrastructure Complete

### Completed
- **P0-BE-006**: 领域事件基础设施 (EventBus, Outbox)

### What was done
1. Defined domain interfaces in `internal/domain/shared/`:
   - `eventbus.go` - EventHandler, EventPublisher, EventSubscriber, EventBus interfaces
   - `outbox.go` - OutboxEntry entity with status management, OutboxRepository interface
   - `event.go` - DomainEvent interface and BaseDomainEvent implementation

2. Implemented EventBus infrastructure at `internal/infrastructure/event/`:
   - `registry.go` - HandlerRegistry for managing event subscriptions (specific + wildcard handlers)
   - `bus.go` - InMemoryEventBus for synchronous in-process pub/sub
   - `serializer.go` - EventSerializer for JSON serialization/deserialization with type registry

3. Implemented Outbox Pattern for reliable event delivery:
   - `outbox_repository.go` - GormOutboxRepository with FOR UPDATE SKIP LOCKED for concurrent processing
   - `outbox_publisher.go` - OutboxPublisher for transactional event persistence
   - `outbox_processor.go` - Background processor with polling, batch processing, retry logic, and cleanup

4. Created database migration:
   - `migrations/000002_create_outbox_events.up.sql` - Outbox table with proper indexes
   - `migrations/000002_create_outbox_events.down.sql` - Rollback script

5. Test coverage (79.6%):
   - `bus_test.go` - InMemoryEventBus tests (publish, subscribe, unsubscribe, wildcard, error handling)
   - `registry_test.go` - HandlerRegistry tests
   - `serializer_test.go` - EventSerializer round-trip tests
   - `outbox_test.go` - OutboxEntry state machine tests
   - `outbox_repository_test.go` - GormOutboxRepository tests
   - `outbox_publisher_test.go` - OutboxPublisher tests
   - `outbox_processor_test.go` - OutboxProcessor tests

### Key Design Decisions
1. **Outbox Pattern**: Events are persisted to database within the same transaction as aggregate changes, then processed asynchronously for reliable delivery
2. **FOR UPDATE SKIP LOCKED**: Prevents double-processing in multi-instance deployments
3. **Exponential Backoff**: Failed events retry with increasing delays (1s, 2s, 4s, 8s, 16s)
4. **Dead Letter**: Events exceeding max retries (default 5) move to DEAD status for manual review
5. **Automatic Cleanup**: Processed events older than 7 days are automatically deleted

### Files created/modified
- `backend/internal/domain/shared/eventbus.go` (new)
- `backend/internal/domain/shared/outbox.go` (new)
- `backend/internal/infrastructure/event/registry.go` (new)
- `backend/internal/infrastructure/event/bus.go` (new)
- `backend/internal/infrastructure/event/serializer.go` (new)
- `backend/internal/infrastructure/event/outbox_repository.go` (new)
- `backend/internal/infrastructure/event/outbox_publisher.go` (new)
- `backend/internal/infrastructure/event/outbox_processor.go` (new)
- `backend/internal/infrastructure/event/*_test.go` (7 test files)
- `backend/migrations/000002_create_outbox_events.up.sql` (new)
- `backend/migrations/000002_create_outbox_events.down.sql` (new)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (79.6% coverage for event package)

### Usage Examples
```go
// Register event type for deserialization
serializer := event.NewEventSerializer()
serializer.Register("ProductCreated", &ProductCreatedEvent{})

// Create event bus
bus := event.NewInMemoryEventBus(logger)
bus.Subscribe(myHandler, "ProductCreated")
bus.Start(ctx)

// Publish events within transaction using OutboxPublisher
publisher := event.NewOutboxPublisher(serializer)
err := db.Transaction(func(tx *gorm.DB) error {
    // Save aggregate
    if err := tx.Save(product).Error; err != nil {
        return err
    }
    // Persist events to outbox (same transaction)
    return publisher.PublishWithTx(ctx, tx, product.Events()...)
})

// Start background processor to deliver events
processor := event.NewOutboxProcessor(repo, bus, serializer, config, logger)
processor.Start(ctx)
```

### Notes for next developer
- P0-BE-007 (Strategy registry) can now be started
- P0-BE-008 (HTTP framework) is partially done from P0-BE-003
- P1-BE-007 (Product domain events) can leverage this infrastructure
- When defining new domain events, remember to register them with EventSerializer
- OutboxProcessor should be started as part of application startup
- For high-throughput scenarios, consider tuning BatchSize and PollInterval
- Test with `go test ./internal/infrastructure/event/... -cover`

---

## 2026-01-23 - P0-BE-008: HTTP Framework Configuration Complete

### Completed
- **P0-BE-008**: HTTP 框架配置 (Gin)

### What was done
1. Added HTTP configuration to config package:
   - `HTTPConfig` struct with ReadTimeout, WriteTimeout, IdleTimeout
   - MaxHeaderBytes, MaxBodySize settings
   - Rate limiting configuration (enabled, requests, window)
   - CORS configuration (origins, methods, headers)
   - Trusted proxies list

2. Implemented common middleware at `internal/interfaces/http/middleware/`:
   - `common.go` - Enhanced with:
     - Configurable CORS middleware (`CORSWithConfig`)
     - Improved RequestID generation using crypto/rand
     - Security headers middleware (`Secure()`) - X-Frame-Options, X-XSS-Protection, etc.
     - Timeout middleware
   - `ratelimit.go` - Token bucket rate limiter:
     - Per-client rate limiting
     - Automatic cleanup of expired entries
     - Tenant-aware rate limiting (X-Tenant-ID header)
     - Custom key extraction support
   - `bodylimit.go` - Request body size limit:
     - Content-Length check
     - MaxBytesReader for streaming protection
   - `validation.go` - Validation helpers:
     - Integration with go-playground/validator
     - Custom error message formatting
     - Structured validation error responses

3. Created router framework at `internal/interfaces/http/router/`:
   - `Router` struct for centralized route registration
   - `RouteRegistrar` interface for modular route registration
   - `DomainGroup` for domain-specific route grouping
   - Support for middleware per group
   - Chained method calls for fluent API
   - Subgroup support for nested routes

4. Updated main.go with:
   - Full middleware stack (RequestID → Recovery → Logger → Security → CORS → BodyLimit → RateLimit)
   - HTTP server configuration from config
   - Domain route groups (catalog, partner, inventory, trade, finance)
   - Ping endpoints for each domain

5. Test coverage:
   - `common_test.go` - 8 test cases for CORS, RequestID, Security, Timeout
   - `ratelimit_test.go` - 10 test cases including concurrent access
   - `bodylimit_test.go` - 4 test cases for body size limiting
   - `validation_test.go` - 4 test cases for validation error handling
   - `router_test.go` - 8 test cases for router and domain groups

### Files created/modified
- `backend/internal/infrastructure/config/config.go` (added HTTPConfig)
- `backend/internal/interfaces/http/middleware/common.go` (enhanced)
- `backend/internal/interfaces/http/middleware/ratelimit.go` (new)
- `backend/internal/interfaces/http/middleware/bodylimit.go` (new)
- `backend/internal/interfaces/http/middleware/validation.go` (new)
- `backend/internal/interfaces/http/middleware/*_test.go` (4 test files)
- `backend/internal/interfaces/http/router/router.go` (new)
- `backend/internal/interfaces/http/router/router_test.go` (new)
- `backend/cmd/server/main.go` (updated with full middleware stack and routes)
- `backend/.env.example` (added HTTP_* and EVENT_* variables)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### API Routes Structure
```
/health                     - Health check (outside versioning)
/api/v1/ping               - Root API ping
/api/v1/catalog/ping       - Catalog service ping
/api/v1/partner/ping       - Partner service ping
/api/v1/inventory/ping     - Inventory service ping
/api/v1/trade/ping         - Trade service ping
/api/v1/finance/ping       - Finance service ping
```

### Middleware Stack Order
1. RequestID - Generate/propagate X-Request-ID
2. Recovery - Catch panics with stack trace logging
3. GinMiddleware - Request logging with zap
4. Secure - Security headers (X-Frame-Options, etc.)
5. CORS - Cross-origin request handling
6. BodyLimit - Request body size limit (default 10MB)
7. RateLimit - Token bucket rate limiting (100 req/min default)

### Notes for next developer
- P0-BE-010 (Unit test framework) is partially done - testify already integrated
- To add new domain APIs, create handlers and register with DomainGroup
- Rate limiter can be customized per route using `RateLimitByKey()`
- CORS can be configured via environment variables
- For production, set HTTP_TRUSTED_PROXIES if behind a reverse proxy
- Validation middleware integrates with Gin's ShouldBindJSON

---

## 2026-01-23 - P0-BE-009: API Response Format Unification Complete

### Completed
- **P0-BE-009**: API 响应格式统一

### What was done
1. Created comprehensive error code constants at `internal/interfaces/http/dto/errors.go`:
   - Standardized error code format: `ERR_<CATEGORY>_<DESCRIPTION>`
   - Categories: General, Validation, Authentication, Resource, Business Rule, Input, Rate Limiting
   - All error codes mapped to appropriate HTTP status codes
   - Legacy error code mapping for backward compatibility with existing domain errors

2. Enhanced Response structure in `internal/interfaces/http/dto/response.go`:
   - `ErrorInfo` now includes:
     - `Code` - Standardized error code
     - `Message` - Human-readable error message
     - `RequestID` - Request correlation ID (from X-Request-ID header)
     - `Timestamp` - When the error occurred
     - `Details` - Array of validation errors (field + message)
     - `Help` - Optional documentation URL
   - New response factory functions:
     - `NewErrorResponseWithRequestID()` - Error with request correlation
     - `NewValidationErrorResponse()` - Validation errors with field details
     - `NewErrorResponseWithDetails()` - Error with additional details
     - `NewErrorResponseWithHelp()` - Error with help URL

3. Updated BaseHandler in `internal/interfaces/http/handler/base.go`:
   - All error methods now include RequestID from context/header
   - New methods: `Unauthorized()`, `Forbidden()`, `Conflict()`, `TooManyRequests()`, `UnprocessableEntity()`
   - `ErrorWithCode()` - Derives HTTP status from error code automatically
   - `ValidationError()` - Sends validation error with field details
   - `HandleError()` - Generic error handler for any error type
   - `HandleDomainError()` - Enhanced to normalize legacy error codes

4. Updated validation middleware in `internal/interfaces/http/middleware/validation.go`:
   - Now uses unified `dto.Response` structure
   - Includes request ID in validation error responses
   - Uses standardized `ERR_VALIDATION` error code

5. Comprehensive test coverage:
   - `dto/errors_test.go` - 14 test cases for error codes, HTTP status mapping, code normalization
   - `handler/base_test.go` - 15 test cases for all handler methods and domain error handling
   - Coverage: dto=88.2%, handler=100%

### Error Code Reference

| Category | Code | HTTP Status |
|----------|------|-------------|
| General | `ERR_UNKNOWN`, `ERR_INTERNAL` | 500 |
| Validation | `ERR_VALIDATION`, `ERR_VALIDATION_*` | 400 |
| Auth | `ERR_UNAUTHORIZED`, `ERR_FORBIDDEN`, `ERR_TOKEN_*` | 401/403 |
| Resource | `ERR_NOT_FOUND`, `ERR_ALREADY_EXISTS`, `ERR_CONFLICT` | 404/409 |
| Business | `ERR_INVALID_STATE`, `ERR_INSUFFICIENT_*` | 422 |
| Input | `ERR_BAD_REQUEST`, `ERR_INVALID_INPUT`, `ERR_INVALID_JSON` | 400 |
| Rate Limit | `ERR_RATE_LIMITED`, `ERR_TOO_MANY_REQUESTS` | 429 |

### Files created/modified
- `backend/internal/interfaces/http/dto/errors.go` (new)
- `backend/internal/interfaces/http/dto/errors_test.go` (new)
- `backend/internal/interfaces/http/dto/response.go` (enhanced)
- `backend/internal/interfaces/http/handler/base.go` (enhanced)
- `backend/internal/interfaces/http/handler/base_test.go` (new)
- `backend/internal/interfaces/http/middleware/validation.go` (updated to use unified response)
- `backend/internal/interfaces/http/middleware/validation_test.go` (updated)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Example API Response Formats

**Success Response:**
```json
{
  "success": true,
  "data": { "id": "123", "name": "Example" }
}
```

**Success with Pagination:**
```json
{
  "success": true,
  "data": [...],
  "meta": {
    "total": 100,
    "page": 1,
    "page_size": 10,
    "total_pages": 10
  }
}
```

**Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "ERR_NOT_FOUND",
    "message": "Resource not found",
    "request_id": "req-abc-123",
    "timestamp": "2026-01-23T10:30:00Z"
  }
}
```

**Validation Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "ERR_VALIDATION",
    "message": "Request validation failed",
    "request_id": "req-def-456",
    "timestamp": "2026-01-23T10:30:00Z",
    "details": [
      { "field": "email", "message": "Invalid email format" },
      { "field": "age", "message": "Must be at least 18" }
    ]
  }
}
```

### Notes for next developer
- P0-BE-010 (Unit test framework) can now be started - testify already integrated, patterns established
- P0-FE-001 (Frontend scaffolding) can use this error format for consistent error handling
- Legacy domain error codes (e.g., "NOT_FOUND") are automatically normalized to new format (e.g., "ERR_NOT_FOUND")
- Use `dto.GetHTTPStatus(code)` to get the HTTP status for any error code
- Use `dto.NormalizeErrorCode(code)` if you need to convert legacy codes
- All handlers should use `h.HandleError(c, err)` or `h.HandleDomainError(c, err)` for consistent error responses
- Request ID is extracted from `X-Request-ID` header or context - set by RequestID middleware

