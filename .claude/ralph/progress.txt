# ERP Development Progress

## 2026-01-23 - P0-BE-001: Backend Scaffolding Complete

### Completed
- **P0-BE-001**: 项目脚手架搭建 (Go Module, 目录结构)

### What was done
1. Created Go module at `backend/` with `github.com/erp/backend`
2. Established DDD directory structure:
   - `cmd/server/` - HTTP server entry point
   - `internal/domain/` - Domain layer with bounded contexts (catalog, partner, inventory, trade, finance, shared)
   - `internal/application/` - Application services (placeholder)
   - `internal/infrastructure/` - Infrastructure (config, persistence, eventbus)
   - `internal/interfaces/http/` - HTTP handlers, DTOs, middleware
   - `migrations/` - Database migrations (empty, ready for P0-BE-004)
   - `tests/` - Unit and integration test directories

3. Installed dependencies:
   - gin-gonic/gin (HTTP framework)
   - gorm.io/gorm + postgres driver (ORM)
   - google/uuid (UUIDs)
   - shopspring/decimal (precise decimals)
   - go-playground/validator/v10 (validation)
   - uber/zap (logging, not yet configured)
   - spf13/viper (config, not yet integrated)
   - golang-jwt/jwt/v5 (authentication)
   - redis/go-redis/v9 (cache/queue)
   - testify (testing)

4. Created shared domain components:
   - `BaseEntity` and `BaseAggregateRoot` with version for optimistic locking
   - `TenantAggregateRoot` for multi-tenant support
   - `DomainEvent` interface and `BaseDomainEvent`
   - `Repository` generic interface with `Filter` and `Paginated` types
   - Common domain errors (NotFound, AlreadyExists, InvalidState, etc.)

5. Created HTTP infrastructure:
   - Unified response format (`dto/response.go`)
   - Base handler with error handling (`handler/base.go`)
   - Common middleware (CORS, RequestID, Logger)
   - Health check and ping endpoints

### Files created
- `backend/go.mod`, `backend/go.sum`
- `backend/cmd/server/main.go`
- `backend/internal/domain/shared/*.go` (5 files)
- `backend/internal/domain/{catalog,partner,inventory,trade,finance}/doc.go`
- `backend/internal/infrastructure/config/config.go`
- `backend/internal/interfaces/http/dto/response.go`
- `backend/internal/interfaces/http/handler/base.go`
- `backend/internal/interfaces/http/middleware/common.go`
- `backend/README.md`, `.gitignore`, `.env.example`

### Build Status
- `go build ./...` passes successfully

### Notes for next developer
- P0-BE-002 (Database connection) depends on this and can now be started
- P0-BE-003 (Logger config) depends on this and can now be started
- Config currently uses env vars directly; may integrate Viper in P0-BE-003
- Main server is functional but minimal - add routes as APIs are developed
- Shared kernel is ready for value objects (P0-BE-005)

---

## 2026-01-23 - P0-BE-002: Database Connection Configuration Complete

### Completed
- **P0-BE-002**: 数据库连接配置 (PostgreSQL)

### What was done
1. Created database connection module at `internal/infrastructure/persistence/database.go`:
   - `Database` struct wrapping GORM DB instance
   - `NewDatabase()` and `NewDatabaseWithLogger()` constructors
   - Connection pool configuration (MaxOpenConns, MaxIdleConns, ConnMaxLifetime, ConnMaxIdleTime)
   - `Close()`, `Ping()`, `Stats()` methods for connection management
   - `Transaction()` method for transactional operations
   - `WithTenant()` method for multi-tenant scoping (with empty tenant ID validation)

2. Enhanced configuration with validation:
   - Added `ConnMaxLifetime` and `ConnMaxIdleTime` config options
   - Added production-specific validation (JWT secret, DB password, SSL mode)
   - Added connection pool validation (MaxIdleConns <= MaxOpenConns)
   - Changed DSN format to URL-style for proper escaping of special characters

3. Integrated database into main server:
   - Database connection on startup with graceful close on shutdown
   - Health check endpoint now returns proper HTTP 503 when database is unhealthy
   - Database status included in health response

4. Security improvements:
   - Production requires JWT secret (min 32 chars), DB password, and SSL enabled
   - Empty tenant ID in `WithTenant()` panics to prevent data leakage
   - DSN uses URL encoding to handle special characters in passwords

5. Test coverage:
   - Unit tests for `Database` struct methods using sqlmock
   - Tests for `ConnectionStats` struct
   - Tests for `WithTenant` including SQL injection prevention
   - Tests for `Transaction` with commit and rollback scenarios
   - Config validation tests for both development and production modes
   - DSN generation tests including special character escaping

### Files created/modified
- `backend/internal/infrastructure/persistence/database.go` (new)
- `backend/internal/infrastructure/persistence/database_test.go` (new)
- `backend/internal/infrastructure/config/config.go` (enhanced with validation)
- `backend/internal/infrastructure/config/config_test.go` (new)
- `backend/cmd/server/main.go` (integrated database)
- `backend/.env.example` (added new config options)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Notes for next developer
- P0-BE-003 (Logger config) can now be started - integrate zap with database logging
- P0-BE-004 (Database migrations) can now be started - database connection is ready
- The `NewDatabaseWithLogger()` function allows custom log levels for debugging
- `WithTenant()` requires non-empty tenant ID - use in middleware after auth
- For integration tests, use testcontainers-go to spin up PostgreSQL
- Health endpoint at `/health` includes database status

---

## 2026-01-23 - P0-BE-003: Logger Framework Configuration Complete

### Completed
- **P0-BE-003**: 日志框架配置

### What was done
1. Created logger package at `internal/infrastructure/logger/` with 4 files:
   - `logger.go` - Core logger initialization with zap, supports different levels (debug/info/warn/error) and formats (json/console)
   - `context.go` - Context helpers for request ID, tenant ID, user ID correlation
   - `gin.go` - Gin middleware for HTTP request logging and panic recovery
   - `gorm.go` - GORM logger adapter that integrates database queries with zap

2. Logger features implemented:
   - Environment-aware logging (development uses console format with colors, production uses JSON)
   - Structured logging with zap fields
   - Request correlation with request_id, tenant_id, user_id
   - HTTP request logging middleware with latency, status codes, client IP, user agent
   - Panic recovery middleware with stack traces
   - GORM query logging with slow query detection (200ms threshold)
   - Log level filtering at both application and database level

3. Configuration added:
   - `LOG_LEVEL` - Log level (debug, info, warn, error)
   - `LOG_FORMAT` - Output format (json, console)
   - `LOG_OUTPUT` - Output destination (stdout, stderr, or file path)

4. Integration completed:
   - Main server uses zap instead of stdlib log
   - Database uses custom GORM logger backed by zap
   - HTTP middleware stack updated: RequestID → Recovery → Logger → CORS
   - Health endpoint now logs warnings on failure

5. Test coverage:
   - 60 unit tests covering all logger functionality
   - Tests for level parsing, encoding, context propagation
   - Tests for Gin middleware (success/error/panic scenarios)
   - Tests for GORM logger (info/warn/error/trace/slow query)

### Files created/modified
- `backend/internal/infrastructure/logger/logger.go` (new)
- `backend/internal/infrastructure/logger/context.go` (new)
- `backend/internal/infrastructure/logger/gin.go` (new)
- `backend/internal/infrastructure/logger/gorm.go` (new)
- `backend/internal/infrastructure/logger/logger_test.go` (new)
- `backend/internal/infrastructure/logger/context_test.go` (new)
- `backend/internal/infrastructure/logger/gin_test.go` (new)
- `backend/internal/infrastructure/logger/gorm_test.go` (new)
- `backend/internal/infrastructure/config/config.go` (added LogConfig)
- `backend/internal/infrastructure/persistence/database.go` (added NewDatabaseWithCustomLogger)
- `backend/cmd/server/main.go` (integrated zap logging)
- `backend/.env.example` (added LOG_* variables)
- `backend/go.mod` (added zap dependency)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (60 new tests in logger package)

### Notes for next developer
- P0-BE-004 (Database migrations) can now be started - logger available for migration output
- P0-BE-008 (HTTP framework) is partially done - Gin middleware stack is configured with logging
- Use `logger.GetGinLogger(c)` in HTTP handlers to get request-scoped logger
- Use `logger.FromContext(ctx)` in application services to get context logger
- GORM logs SQL queries at DEBUG level, slow queries (>200ms) at WARN level
- Production mode uses JSON format with ISO8601 timestamps
- Set LOG_LEVEL=debug to see SQL queries in development

---

## 2026-01-23 - P0-BE-004: Database Migration Tool Configuration Complete

### Completed
- **P0-BE-004**: 数据库迁移工具配置 (golang-migrate)

### What was done
1. Integrated golang-migrate library:
   - Added `github.com/golang-migrate/migrate/v4` dependency
   - Added `github.com/lib/pq` for native PostgreSQL driver support in CLI

2. Created migration infrastructure at `internal/infrastructure/migration/`:
   - `migrate.go` - Core Migrator struct wrapping golang-migrate
     - `New()` and `NewFromURL()` constructors
     - `Up()`, `Down()`, `Steps()`, `GoTo()` migration methods
     - `Version()`, `Force()`, `Drop()` utility methods
     - Integrated with zap logger for structured logging
   - `creator.go` - Migration file creation utilities
     - `CreateMigration()` creates up/down SQL file pairs
     - Template-based migration file generation
     - Version format: YYYYMMDDHHMMSS for proper ordering
     - `ListMigrations()` to enumerate available migrations

3. Created migration CLI at `cmd/migrate/`:
   - Full-featured CLI for database migrations
   - Commands: up, down, step, goto, version, force, drop, create, list
   - Configurable migrations path and log level
   - Uses same database config as main server
   - Safety features: drop requires `-confirm` flag

4. Created initial migration:
   - `migrations/000001_init_schema.up.sql`:
     - Enables uuid-ossp and pgcrypto extensions
     - Creates tenants table with multi-tenancy support
     - Implements `update_updated_at_column()` trigger function
     - Adds default tenant for development
   - `migrations/000001_init_schema.down.sql`:
     - Clean rollback of all schema changes

5. Test coverage:
   - Unit tests for migration creator functions
   - Tests for name sanitization
   - Tests for file creation and directory handling
   - Tests for migration listing

### Files created/modified
- `backend/internal/infrastructure/migration/migrate.go` (new)
- `backend/internal/infrastructure/migration/creator.go` (new)
- `backend/internal/infrastructure/migration/creator_test.go` (new)
- `backend/cmd/migrate/main.go` (new)
- `backend/migrations/000001_init_schema.up.sql` (new)
- `backend/migrations/000001_init_schema.down.sql` (new)
- `backend/README.md` (updated with migration documentation)
- `backend/.env.example` (added MIGRATIONS_PATH)
- `backend/go.mod` (added golang-migrate and pq dependencies)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Usage Examples
```bash
# Build the migration CLI
go build -o bin/migrate cmd/migrate/main.go

# Apply all pending migrations
./bin/migrate up

# Create a new migration
./bin/migrate create add_users_table "Create users table"

# Check current version
./bin/migrate version

# Roll back last migration
./bin/migrate step -1
```

### Notes for next developer
- P0-BE-005 (Value objects) can now be started - migrations are ready for new tables
- P0-BE-006 (Event bus) can now be started - database foundation is complete
- Initial migration creates tenants table for multi-tenancy
- Use `./bin/migrate create <name>` to add new migrations
- Migrations use YYYYMMDDHHMMSS versioning for proper ordering
- The Migrator integrates with zap logger for structured output
- Force command should only be used to fix dirty state
- Drop command is destructive and requires explicit confirmation

---

## 2026-01-23 - P0-BE-005: Common Value Objects Complete

### Completed
- **P0-BE-005**: 通用值对象实现 (Money, Quantity)

### What was done
1. Added shopspring/decimal dependency for precise decimal arithmetic:
   - `github.com/shopspring/decimal v1.4.0`

2. Implemented Money value object at `internal/domain/shared/valueobject/money.go`:
   - Immutable design - all operations return new instances
   - Multiple currency support (CNY, USD, EUR, GBP, JPY, HKD)
   - Factory methods: `NewMoney()`, `NewMoneyFromFloat()`, `NewMoneyFromInt()`, `NewMoneyFromString()`
   - CNY-specific helpers: `NewMoneyCNY()`, `NewMoneyCNYFromFloat()`, `ZeroCNY()`
   - Arithmetic: `Add()`, `Subtract()`, `Multiply()`, `Divide()`, `Negate()`, `Abs()`
   - Comparisons: `Equals()`, `LessThan()`, `GreaterThan()`, `LessThanOrEqual()`, `GreaterThanOrEqual()`
   - Rounding: `Round()`, `RoundBank()`, `Truncate()`
   - Business operations: `Allocate()` (fair division), `CalculatePercentage()`, `ApplyDiscount()`
   - JSON serialization: `MarshalJSON()`, `UnmarshalJSON()`
   - Database support: `Value()` (driver.Valuer), `Scan()` (sql.Scanner)

3. Implemented Quantity value object at `internal/domain/shared/valueobject/quantity.go`:
   - Immutable design - all operations return new instances
   - Non-negative enforcement (prevents negative inventory)
   - Unit of measurement support
   - Factory methods: `NewQuantity()`, `NewQuantityFromFloat()`, `NewQuantityFromInt()`, `NewIntegerQuantity()`
   - Arithmetic: `Add()`, `Subtract()`, `Multiply()`, `Divide()`
   - Unit conversion: `Convert()`, `ConvertByFloat()`
   - Rounding: `Round()`, `Truncate()`, `Ceiling()`, `Floor()`
   - Inventory helpers: `SufficientFor()`, `Deficit()`, `Split()`
   - Allows negative with `SubtractAllowNegative()` for deficit calculation
   - JSON and database support

4. Comprehensive unit tests:
   - `money_test.go`: 27 test cases covering all Money functionality
   - `quantity_test.go`: 25 test cases covering all Quantity functionality
   - Test coverage: 86.3% of statements

### Files created/modified
- `backend/internal/domain/shared/valueobject/money.go` (new)
- `backend/internal/domain/shared/valueobject/money_test.go` (new)
- `backend/internal/domain/shared/valueobject/quantity.go` (new)
- `backend/internal/domain/shared/valueobject/quantity_test.go` (new)
- `backend/go.mod` (added shopspring/decimal)
- `backend/go.sum` (updated)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (86.3% coverage for valueobject package)

### Key Design Decisions
1. **Immutability**: All methods return new instances to prevent accidental mutation
2. **Currency safety**: Money operations fail if currencies don't match
3. **Non-negative Quantity**: Standard subtract fails if result would be negative; use `SubtractAllowNegative()` for deficit calculation
4. **Decimal precision**: Uses shopspring/decimal for financial calculations (no floating-point errors)
5. **Database storage**: Values stored as strings to preserve precision

### Usage Examples
```go
// Money
price := NewMoneyCNYFromFloat(99.99)
quantity := 3
total := price.MultiplyByInt(quantity) // 299.97 CNY

discount := total.ApplyDiscount(decimal.NewFromInt(10)) // 10% off
parts, _ := total.Allocate(3) // Fair division for split payments

// Quantity
stock, _ := NewQuantityFromInt(100, "pcs")
ordered, _ := NewQuantityFromInt(30, "pcs")
remaining, _ := stock.Subtract(ordered) // 70 pcs

sufficient, _ := stock.SufficientFor(ordered) // true
deficit, _ := ordered.Deficit(stock) // 0 pcs (no deficit)

// Unit conversion (1000g = 1kg)
grams, _ := NewQuantityFromInt(1000, "g")
kg, _ := grams.Convert("kg", decimal.NewFromFloat(0.001)) // 1 kg
```

### Notes for next developer
- P0-BE-006 (Event bus) can now be started - value objects ready
- P0-BE-008 (HTTP framework) is partially done from P0-BE-003
- Money uses `DefaultCurrency = CNY` when scanning from database without currency
- For multi-currency systems, store currency alongside amount in database
- Use `MustAdd()` / `MustSubtract()` when you're certain units/currencies match (panics on mismatch)
- Quantity's `Convert()` is for unit conversion, not currency conversion

---

## 2026-01-23 - P0-BE-006: Domain Event Infrastructure Complete

### Completed
- **P0-BE-006**: 领域事件基础设施 (EventBus, Outbox)

### What was done
1. Defined domain interfaces in `internal/domain/shared/`:
   - `eventbus.go` - EventHandler, EventPublisher, EventSubscriber, EventBus interfaces
   - `outbox.go` - OutboxEntry entity with status management, OutboxRepository interface
   - `event.go` - DomainEvent interface and BaseDomainEvent implementation

2. Implemented EventBus infrastructure at `internal/infrastructure/event/`:
   - `registry.go` - HandlerRegistry for managing event subscriptions (specific + wildcard handlers)
   - `bus.go` - InMemoryEventBus for synchronous in-process pub/sub
   - `serializer.go` - EventSerializer for JSON serialization/deserialization with type registry

3. Implemented Outbox Pattern for reliable event delivery:
   - `outbox_repository.go` - GormOutboxRepository with FOR UPDATE SKIP LOCKED for concurrent processing
   - `outbox_publisher.go` - OutboxPublisher for transactional event persistence
   - `outbox_processor.go` - Background processor with polling, batch processing, retry logic, and cleanup

4. Created database migration:
   - `migrations/000002_create_outbox_events.up.sql` - Outbox table with proper indexes
   - `migrations/000002_create_outbox_events.down.sql` - Rollback script

5. Test coverage (79.6%):
   - `bus_test.go` - InMemoryEventBus tests (publish, subscribe, unsubscribe, wildcard, error handling)
   - `registry_test.go` - HandlerRegistry tests
   - `serializer_test.go` - EventSerializer round-trip tests
   - `outbox_test.go` - OutboxEntry state machine tests
   - `outbox_repository_test.go` - GormOutboxRepository tests
   - `outbox_publisher_test.go` - OutboxPublisher tests
   - `outbox_processor_test.go` - OutboxProcessor tests

### Key Design Decisions
1. **Outbox Pattern**: Events are persisted to database within the same transaction as aggregate changes, then processed asynchronously for reliable delivery
2. **FOR UPDATE SKIP LOCKED**: Prevents double-processing in multi-instance deployments
3. **Exponential Backoff**: Failed events retry with increasing delays (1s, 2s, 4s, 8s, 16s)
4. **Dead Letter**: Events exceeding max retries (default 5) move to DEAD status for manual review
5. **Automatic Cleanup**: Processed events older than 7 days are automatically deleted

### Files created/modified
- `backend/internal/domain/shared/eventbus.go` (new)
- `backend/internal/domain/shared/outbox.go` (new)
- `backend/internal/infrastructure/event/registry.go` (new)
- `backend/internal/infrastructure/event/bus.go` (new)
- `backend/internal/infrastructure/event/serializer.go` (new)
- `backend/internal/infrastructure/event/outbox_repository.go` (new)
- `backend/internal/infrastructure/event/outbox_publisher.go` (new)
- `backend/internal/infrastructure/event/outbox_processor.go` (new)
- `backend/internal/infrastructure/event/*_test.go` (7 test files)
- `backend/migrations/000002_create_outbox_events.up.sql` (new)
- `backend/migrations/000002_create_outbox_events.down.sql` (new)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (79.6% coverage for event package)

### Usage Examples
```go
// Register event type for deserialization
serializer := event.NewEventSerializer()
serializer.Register("ProductCreated", &ProductCreatedEvent{})

// Create event bus
bus := event.NewInMemoryEventBus(logger)
bus.Subscribe(myHandler, "ProductCreated")
bus.Start(ctx)

// Publish events within transaction using OutboxPublisher
publisher := event.NewOutboxPublisher(serializer)
err := db.Transaction(func(tx *gorm.DB) error {
    // Save aggregate
    if err := tx.Save(product).Error; err != nil {
        return err
    }
    // Persist events to outbox (same transaction)
    return publisher.PublishWithTx(ctx, tx, product.Events()...)
})

// Start background processor to deliver events
processor := event.NewOutboxProcessor(repo, bus, serializer, config, logger)
processor.Start(ctx)
```

### Notes for next developer
- P0-BE-007 (Strategy registry) can now be started
- P0-BE-008 (HTTP framework) is partially done from P0-BE-003
- P1-BE-007 (Product domain events) can leverage this infrastructure
- When defining new domain events, remember to register them with EventSerializer
- OutboxProcessor should be started as part of application startup
- For high-throughput scenarios, consider tuning BatchSize and PollInterval
- Test with `go test ./internal/infrastructure/event/... -cover`

---

## 2026-01-23 - P0-BE-008: HTTP Framework Configuration Complete

### Completed
- **P0-BE-008**: HTTP 框架配置 (Gin)

### What was done
1. Added HTTP configuration to config package:
   - `HTTPConfig` struct with ReadTimeout, WriteTimeout, IdleTimeout
   - MaxHeaderBytes, MaxBodySize settings
   - Rate limiting configuration (enabled, requests, window)
   - CORS configuration (origins, methods, headers)
   - Trusted proxies list

2. Implemented common middleware at `internal/interfaces/http/middleware/`:
   - `common.go` - Enhanced with:
     - Configurable CORS middleware (`CORSWithConfig`)
     - Improved RequestID generation using crypto/rand
     - Security headers middleware (`Secure()`) - X-Frame-Options, X-XSS-Protection, etc.
     - Timeout middleware
   - `ratelimit.go` - Token bucket rate limiter:
     - Per-client rate limiting
     - Automatic cleanup of expired entries
     - Tenant-aware rate limiting (X-Tenant-ID header)
     - Custom key extraction support
   - `bodylimit.go` - Request body size limit:
     - Content-Length check
     - MaxBytesReader for streaming protection
   - `validation.go` - Validation helpers:
     - Integration with go-playground/validator
     - Custom error message formatting
     - Structured validation error responses

3. Created router framework at `internal/interfaces/http/router/`:
   - `Router` struct for centralized route registration
   - `RouteRegistrar` interface for modular route registration
   - `DomainGroup` for domain-specific route grouping
   - Support for middleware per group
   - Chained method calls for fluent API
   - Subgroup support for nested routes

4. Updated main.go with:
   - Full middleware stack (RequestID → Recovery → Logger → Security → CORS → BodyLimit → RateLimit)
   - HTTP server configuration from config
   - Domain route groups (catalog, partner, inventory, trade, finance)
   - Ping endpoints for each domain

5. Test coverage:
   - `common_test.go` - 8 test cases for CORS, RequestID, Security, Timeout
   - `ratelimit_test.go` - 10 test cases including concurrent access
   - `bodylimit_test.go` - 4 test cases for body size limiting
   - `validation_test.go` - 4 test cases for validation error handling
   - `router_test.go` - 8 test cases for router and domain groups

### Files created/modified
- `backend/internal/infrastructure/config/config.go` (added HTTPConfig)
- `backend/internal/interfaces/http/middleware/common.go` (enhanced)
- `backend/internal/interfaces/http/middleware/ratelimit.go` (new)
- `backend/internal/interfaces/http/middleware/bodylimit.go` (new)
- `backend/internal/interfaces/http/middleware/validation.go` (new)
- `backend/internal/interfaces/http/middleware/*_test.go` (4 test files)
- `backend/internal/interfaces/http/router/router.go` (new)
- `backend/internal/interfaces/http/router/router_test.go` (new)
- `backend/cmd/server/main.go` (updated with full middleware stack and routes)
- `backend/.env.example` (added HTTP_* and EVENT_* variables)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### API Routes Structure
```
/health                     - Health check (outside versioning)
/api/v1/ping               - Root API ping
/api/v1/catalog/ping       - Catalog service ping
/api/v1/partner/ping       - Partner service ping
/api/v1/inventory/ping     - Inventory service ping
/api/v1/trade/ping         - Trade service ping
/api/v1/finance/ping       - Finance service ping
```

### Middleware Stack Order
1. RequestID - Generate/propagate X-Request-ID
2. Recovery - Catch panics with stack trace logging
3. GinMiddleware - Request logging with zap
4. Secure - Security headers (X-Frame-Options, etc.)
5. CORS - Cross-origin request handling
6. BodyLimit - Request body size limit (default 10MB)
7. RateLimit - Token bucket rate limiting (100 req/min default)

### Notes for next developer
- P0-BE-010 (Unit test framework) is partially done - testify already integrated
- To add new domain APIs, create handlers and register with DomainGroup
- Rate limiter can be customized per route using `RateLimitByKey()`
- CORS can be configured via environment variables
- For production, set HTTP_TRUSTED_PROXIES if behind a reverse proxy
- Validation middleware integrates with Gin's ShouldBindJSON

---

## 2026-01-23 - P0-BE-009: API Response Format Unification Complete

### Completed
- **P0-BE-009**: API 响应格式统一

### What was done
1. Created comprehensive error code constants at `internal/interfaces/http/dto/errors.go`:
   - Standardized error code format: `ERR_<CATEGORY>_<DESCRIPTION>`
   - Categories: General, Validation, Authentication, Resource, Business Rule, Input, Rate Limiting
   - All error codes mapped to appropriate HTTP status codes
   - Legacy error code mapping for backward compatibility with existing domain errors

2. Enhanced Response structure in `internal/interfaces/http/dto/response.go`:
   - `ErrorInfo` now includes:
     - `Code` - Standardized error code
     - `Message` - Human-readable error message
     - `RequestID` - Request correlation ID (from X-Request-ID header)
     - `Timestamp` - When the error occurred
     - `Details` - Array of validation errors (field + message)
     - `Help` - Optional documentation URL
   - New response factory functions:
     - `NewErrorResponseWithRequestID()` - Error with request correlation
     - `NewValidationErrorResponse()` - Validation errors with field details
     - `NewErrorResponseWithDetails()` - Error with additional details
     - `NewErrorResponseWithHelp()` - Error with help URL

3. Updated BaseHandler in `internal/interfaces/http/handler/base.go`:
   - All error methods now include RequestID from context/header
   - New methods: `Unauthorized()`, `Forbidden()`, `Conflict()`, `TooManyRequests()`, `UnprocessableEntity()`
   - `ErrorWithCode()` - Derives HTTP status from error code automatically
   - `ValidationError()` - Sends validation error with field details
   - `HandleError()` - Generic error handler for any error type
   - `HandleDomainError()` - Enhanced to normalize legacy error codes

4. Updated validation middleware in `internal/interfaces/http/middleware/validation.go`:
   - Now uses unified `dto.Response` structure
   - Includes request ID in validation error responses
   - Uses standardized `ERR_VALIDATION` error code

5. Comprehensive test coverage:
   - `dto/errors_test.go` - 14 test cases for error codes, HTTP status mapping, code normalization
   - `handler/base_test.go` - 15 test cases for all handler methods and domain error handling
   - Coverage: dto=88.2%, handler=100%

### Error Code Reference

| Category | Code | HTTP Status |
|----------|------|-------------|
| General | `ERR_UNKNOWN`, `ERR_INTERNAL` | 500 |
| Validation | `ERR_VALIDATION`, `ERR_VALIDATION_*` | 400 |
| Auth | `ERR_UNAUTHORIZED`, `ERR_FORBIDDEN`, `ERR_TOKEN_*` | 401/403 |
| Resource | `ERR_NOT_FOUND`, `ERR_ALREADY_EXISTS`, `ERR_CONFLICT` | 404/409 |
| Business | `ERR_INVALID_STATE`, `ERR_INSUFFICIENT_*` | 422 |
| Input | `ERR_BAD_REQUEST`, `ERR_INVALID_INPUT`, `ERR_INVALID_JSON` | 400 |
| Rate Limit | `ERR_RATE_LIMITED`, `ERR_TOO_MANY_REQUESTS` | 429 |

### Files created/modified
- `backend/internal/interfaces/http/dto/errors.go` (new)
- `backend/internal/interfaces/http/dto/errors_test.go` (new)
- `backend/internal/interfaces/http/dto/response.go` (enhanced)
- `backend/internal/interfaces/http/handler/base.go` (enhanced)
- `backend/internal/interfaces/http/handler/base_test.go` (new)
- `backend/internal/interfaces/http/middleware/validation.go` (updated to use unified response)
- `backend/internal/interfaces/http/middleware/validation_test.go` (updated)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests

### Example API Response Formats

**Success Response:**
```json
{
  "success": true,
  "data": { "id": "123", "name": "Example" }
}
```

**Success with Pagination:**
```json
{
  "success": true,
  "data": [...],
  "meta": {
    "total": 100,
    "page": 1,
    "page_size": 10,
    "total_pages": 10
  }
}
```

**Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "ERR_NOT_FOUND",
    "message": "Resource not found",
    "request_id": "req-abc-123",
    "timestamp": "2026-01-23T10:30:00Z"
  }
}
```

**Validation Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "ERR_VALIDATION",
    "message": "Request validation failed",
    "request_id": "req-def-456",
    "timestamp": "2026-01-23T10:30:00Z",
    "details": [
      { "field": "email", "message": "Invalid email format" },
      { "field": "age", "message": "Must be at least 18" }
    ]
  }
}
```

### Notes for next developer
- P0-BE-010 (Unit test framework) can now be started - testify already integrated, patterns established
- P0-FE-001 (Frontend scaffolding) can use this error format for consistent error handling
- Legacy domain error codes (e.g., "NOT_FOUND") are automatically normalized to new format (e.g., "ERR_NOT_FOUND")
- Use `dto.GetHTTPStatus(code)` to get the HTTP status for any error code
- Use `dto.NormalizeErrorCode(code)` if you need to convert legacy codes
- All handlers should use `h.HandleError(c, err)` or `h.HandleDomainError(c, err)` for consistent error responses
- Request ID is extracted from `X-Request-ID` header or context - set by RequestID middleware

---

## 2026-01-23 - P0-BE-010: Unit Test Framework Configuration Complete

### Completed
- **P0-BE-010**: 单元测试框架配置

### What was done
1. Testify integration already complete from P0-BE-001:
   - `github.com/stretchr/testify v1.11.1` for assertions
   - `github.com/DATA-DOG/go-sqlmock v1.5.2` for database mocking
   - 24 existing test files with comprehensive coverage

2. Created test coverage tooling:
   - `backend/Makefile` with coverage targets:
     - `make test` - Run all tests
     - `make test-unit` - Run unit tests only
     - `make test-race` - Run with race detector
     - `make test-coverage` - Run with coverage report
     - `make test-coverage-html` - Generate HTML coverage report
     - `make test-coverage-ci` - CI coverage with 80% threshold check
   - Coverage configuration for CI/CD integration

3. Created test utility package at `tests/testutil/`:
   - `testutil.go` - Core test utilities:
     - `NewMockDB(t)` - Creates mock database with sqlmock
     - `NewTestContext(t)` - Creates Gin test context
     - `NewTestUUID(seed)` - Deterministic UUIDs for reproducible tests
     - `TestTenantID()`, `TestUserID()` - Standard test identifiers
     - `ContextWithTimeout()`, `ContextWithCancel()` - Context helpers
     - `AssertEventually()`, `AssertNever()` - Async assertions
   - `http.go` - HTTP testing utilities:
     - `HTTPTestCase` struct for table-driven HTTP tests
     - `RunHTTPTestCases()` - Batch test runner
     - `JSONResponse()`, `JSONResponseAs[T]()` - Response parsing
     - `AssertSuccessResponse()`, `AssertErrorResponse()` - API assertions
     - `ToJSONReader()` - JSON body creation
   - `event.go` - Event testing utilities:
     - `MockEventHandler` - Thread-safe mock event handler
     - `TestEvent` - Simple domain event for testing
     - `NewTestEvent()`, `NewTestEventWithID()` - Event factories
     - `WaitForCondition()`, `WaitForEventCount()` - Async event testing

4. Test coverage for testutil package:
   - `testutil_test.go` - 30 test cases
   - `event_test.go` - 8 test cases
   - Coverage: 81.2% of statements

### Files created/modified
- `backend/Makefile` (new)
- `backend/tests/testutil/testutil.go` (new)
- `backend/tests/testutil/http.go` (new)
- `backend/tests/testutil/event.go` (new)
- `backend/tests/testutil/testutil_test.go` (new)
- `backend/tests/testutil/event_test.go` (new)
- `backend/README.md` (updated with testing documentation)

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (38 new tests in testutil package)
- `make test-coverage` works correctly

### Current Test Statistics
| Package | Coverage |
|---------|----------|
| valueobject | 86.3% |
| logger | 98.5% |
| strategy | 90.5% |
| dto | 89.5% |
| handler | 100.0% |
| router | 100.0% |
| testutil | 81.2% |
| event | 79.6% |
| config | 74.1% |
| middleware | 72.0% |
| **Overall** | **63.0%** |

### Usage Examples
```go
// Mock database testing
mockDB := testutil.NewMockDB(t)
defer mockDB.Close()
mockDB.Mock.ExpectQuery(...).WillReturnRows(...)

// HTTP handler testing
tc := testutil.NewTestContext(t)
tc.SetRequestID("req-123")
tc.SetTenantID("tenant-456")
handler(tc.Context)
testutil.AssertSuccessResponse(t, tc)

// Event testing
handler := testutil.NewMockEventHandler("ProductCreated")
event := testutil.NewTestEvent("ProductCreated", testutil.TestTenantID())
testutil.WaitForEventCount(t, handler, 1, 5*time.Second)

// Async assertions
testutil.AssertEventually(t, func() bool {
    return someCondition
}, 5*time.Second, 100*time.Millisecond)
```

### Makefile Targets
```bash
make test              # Run all tests
make test-unit         # Run unit tests (./internal/...)
make test-race         # Run with race detector
make test-coverage     # Run with coverage report
make test-coverage-html # Generate HTML report
make test-coverage-ci  # CI with 80% threshold
make test-pkg PKG=./internal/domain/... # Test specific package
make lint              # Run linter
make fmt               # Format code
make ci                # Run all CI checks
```

### Notes for next developer
- P0-FE-001 (Frontend scaffolding) is the next highest priority incomplete task
- All P0 backend tasks are now complete
- Use `make test-coverage-html` to view detailed coverage report in browser
- The testutil package provides helpers for database, HTTP, and event testing
- Coverage threshold is 80% - CI will fail if below this
- Use `testutil.NewTestUUID("seed")` for deterministic UUIDs in tests
- Use `testutil.AssertEventually()` for async assertions instead of `time.Sleep()`

---

## 2026-01-23 - P0-FE-001: Frontend Project Scaffolding Complete

### Completed
- **P0-FE-001**: 前端项目脚手架搭建 (React + TypeScript)

### What was done
1. Created React + TypeScript project using Vite:
   - `npm create vite@latest frontend -- --template react-ts`
   - React 19.2.0, TypeScript 5.9.3, Vite 7.2.4

2. Configured ESLint and Prettier:
   - ESLint with TypeScript, React, React Hooks plugins
   - Prettier integration via eslint-plugin-prettier
   - `.prettierrc` with project conventions (no semicolons, single quotes)
   - `.prettierignore` for build artifacts

3. Established directory structure:
   ```
   frontend/
   ├── src/
   │   ├── assets/          # Static assets (images, fonts)
   │   ├── components/
   │   │   ├── common/      # Reusable UI components
   │   │   └── layout/      # Layout components
   │   ├── features/        # Feature-based modules
   │   │   ├── catalog/     # Products, Categories
   │   │   ├── partner/     # Customers, Suppliers, Warehouses
   │   │   ├── inventory/   # Stock management
   │   │   ├── trade/       # Sales, Purchases, Returns
   │   │   └── finance/     # Receivables, Payables
   │   ├── hooks/           # Custom React hooks
   │   ├── pages/           # Route page components
   │   ├── services/        # API services
   │   ├── store/           # Zustand stores
   │   ├── types/           # TypeScript definitions
   │   └── utils/           # Utility functions
   ├── .env.example
   ├── .prettierrc
   ├── eslint.config.js
   ├── tsconfig.app.json
   └── vite.config.ts
   ```

4. Configured path aliases:
   - `@/*` → `src/*`
   - `@components/*`, `@features/*`, `@hooks/*`, etc.
   - Configured in both `vite.config.ts` and `tsconfig.app.json`

5. Created TypeScript types matching backend:
   - `ApiResponse<T>` - Standard response format
   - `ApiError` - Error structure with code, message, request_id
   - `PaginationMeta`, `PaginationParams` - Pagination support
   - `BaseEntity`, `TenantEntity` - Entity base types

6. Configured Vite:
   - Development server on port 3000
   - API proxy to backend (localhost:8080)
   - Path aliases for clean imports

### Files created/modified
- `frontend/` - Entire frontend directory (new)
- `frontend/package.json` - Project configuration with scripts
- `frontend/eslint.config.js` - ESLint flat config
- `frontend/.prettierrc` - Prettier configuration
- `frontend/.prettierignore` - Prettier ignore patterns
- `frontend/vite.config.ts` - Vite configuration with aliases and proxy
- `frontend/tsconfig.app.json` - TypeScript config with path aliases
- `frontend/src/types/api.ts` - API type definitions
- `frontend/src/App.tsx` - Clean starter app
- Feature directories with placeholder index.ts files

### Build Status
- `npm run type-check` passes
- `npm run lint` passes
- `npm run build` passes (193KB JS bundle gzipped to 61KB)

### NPM Scripts
```bash
npm run dev          # Start dev server (port 3000)
npm run build        # Production build
npm run preview      # Preview production build
npm run lint         # Run ESLint
npm run lint:fix     # Fix ESLint issues
npm run format       # Format with Prettier
npm run format:check # Check formatting
npm run type-check   # TypeScript check
```

### Notes for next developer
- P0-FE-002 (Semi Design UI) is the next highest priority task
- P0-FE-003 (Routing) depends on P0-FE-002 for layout components
- Use `@/` imports for clean module references
- API types match backend `dto/response.go` format
- Dev server proxies `/api` requests to backend on port 8080
- ESLint + Prettier run automatically on lint:fix

---

## 2026-01-23 - P0-API-001: OpenAPI Specification and SDK Auto-Generation Complete

### Completed
- **P0-API-001**: OpenAPI 规范与 SDK 自动生成
- **P0-FE-005**: HTTP 客户端封装 (Axios) - completed as part of this task

### What was done
1. Backend: Integrated swaggo/swag for OpenAPI generation:
   - Added `github.com/swaggo/swag`, `github.com/swaggo/gin-swagger`, `github.com/swaggo/files` dependencies
   - Added general API info annotations to `cmd/server/main.go` (title, version, description, security)
   - Created Swagger UI endpoint at `/swagger/*any`
   - Configured `@securityDefinitions.apikey BearerAuth` for JWT authentication

2. Backend: Created example API with full swagger annotations:
   - `internal/interfaces/http/handler/system.go` - SystemHandler with GetSystemInfo and Ping endpoints
   - Full swagger annotations including `@Summary`, `@Description`, `@Tags`, `@Param`, `@Success`, `@Failure`, `@Router`
   - Unit tests for SystemHandler in `system_test.go`

3. Backend: Updated Makefile with documentation targets:
   - `make docs` - Generate OpenAPI spec from Go annotations
   - `make docs-check` - Verify OpenAPI docs are up-to-date (for CI)
   - Updated `dev-deps` target to install swag CLI
   - Updated CI target to include docs-check

4. Frontend: Integrated orval for TypeScript SDK generation:
   - Installed axios and orval dependencies
   - Created `orval.config.ts` with configuration for tags-split mode
   - Created `src/services/axios-instance.ts` with:
     - Base axios instance with configurable base URL
     - Request interceptor for JWT token injection and request ID
     - Response interceptor for error handling (401, 403, 429, 500)
     - Custom instance function for orval integration

5. Frontend: Added npm scripts for API generation:
   - `npm run api:generate` - Generate TypeScript SDK from OpenAPI spec
   - `npm run api:watch` - Watch mode for continuous generation

6. Generated TypeScript SDK:
   - `src/api/system/system.ts` - System API client with typed functions
   - `src/api/models/*.ts` - TypeScript interfaces for all DTOs
   - Auto-generated from backend OpenAPI spec

### Files created/modified
**Backend:**
- `backend/cmd/server/main.go` (added swagger annotations and imports)
- `backend/internal/interfaces/http/handler/system.go` (new)
- `backend/internal/interfaces/http/handler/system_test.go` (new)
- `backend/docs/swagger.yaml` (generated)
- `backend/docs/swagger.json` (generated)
- `backend/docs/docs.go` (generated)
- `backend/Makefile` (added docs targets)
- `backend/go.mod` (added swagger dependencies)

**Frontend:**
- `frontend/package.json` (added api:generate scripts, axios, orval)
- `frontend/orval.config.ts` (new)
- `frontend/src/services/axios-instance.ts` (new)
- `frontend/src/services/index.ts` (updated with exports)
- `frontend/src/api/**/*.ts` (auto-generated SDK files)

### Build Status
- Backend: `go build ./...` passes
- Backend: `go test ./...` passes all tests
- Frontend: `npm run type-check` passes
- Frontend: `npm run build` passes
- Frontend: `npm run lint` passes

### API Documentation
Available at: `http://localhost:8080/swagger/index.html` when server is running

### Example API Endpoints
```
GET /api/v1/system/info   - Get system information
GET /api/v1/system/ping   - Ping the API
```

### Usage Examples

**Backend: Adding a new API endpoint**
```go
// CreateProduct godoc
// @Summary      Create a new product
// @Description  Create a new product in the catalog
// @Tags         products
// @Accept       json
// @Produce      json
// @Param        request body dto.CreateProductRequest true "Product creation request"
// @Success      201 {object} dto.Response{data=dto.ProductResponse}
// @Failure      400 {object} dto.Response{error=dto.ErrorInfo}
// @Router       /products [post]
func (h *ProductHandler) Create(c *gin.Context) {
    // implementation
}
```

**Frontend: Using the generated SDK**
```typescript
import { getSystem } from '@/services'

const api = getSystem()

// Fetch system info with full type safety
const info = await api.getSystemInfo()
console.log(info.data?.name)    // "ERP Backend API"
console.log(info.data?.version) // "1.0.0"
```

### Workflow for Adding New APIs
1. Add handler with swagger annotations in backend
2. Run `make docs` in backend to regenerate OpenAPI spec
3. Run `npm run api:generate` in frontend to regenerate TypeScript SDK
4. Use the auto-generated typed client in frontend code

### Notes for next developer
- P0-FE-002 (Semi Design UI) is the next highest priority task
- All generated files in `frontend/src/api/` are auto-generated - DO NOT edit manually
- Run `make docs-check` to verify OpenAPI spec is up-to-date before committing
- Swagger UI available at `/swagger/index.html` for API exploration
- The axios instance handles JWT token injection automatically from localStorage
- Use `customInstance` function for orval integration, not `axiosInstance` directly

---

## 2026-01-23 - P0-FE-002: UI Component Library Integration (Semi Design) Complete

### Completed
- **P0-FE-002**: UI 组件库集成 (Semi Design)

### What was done
1. Installed Semi Design packages:
   - `@douyinfe/semi-ui` - Main UI component library
   - `@douyinfe/semi-icons` - Icon library

2. Configured global styles:
   - Created new `index.css` with CSS reset and Semi Design CSS variables
   - Set up base typography using Semi Design's font stack
   - Added custom scrollbar styling using Semi Design colors
   - Configured selection styling with Semi Design theme colors

3. Updated App.tsx with component verification demo:
   - Demonstrates multiple Semi Design components working together
   - Components tested: Button, Card, Typography, Space, Tag, Input, Toast, Table, Avatar, Descriptions
   - Icons tested: IconHome, IconSearch, IconUser, IconSetting, IconGithubLogo
   - Interactive elements (Toast notification on button click)

4. Removed unused App.css file (replaced by Semi Design styling)

### Files created/modified
- `frontend/package.json` (added semi-ui and semi-icons dependencies)
- `frontend/src/index.css` (rewritten for Semi Design)
- `frontend/src/App.tsx` (component demo with Semi Design)
- `frontend/src/App.css` (deleted - no longer needed)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes
- `npm run build` passes (676KB JS bundle, gzipped to 201KB)
- Note: Chunk size warning is expected - can be optimized with code-splitting later

### Components Verified
| Component | Status |
|-----------|--------|
| Button (all types) | Working |
| Card | Working |
| Typography (Title, Text, Paragraph) | Working |
| Space | Working |
| Tag (all colors) | Working |
| Input with prefix icon | Working |
| Toast | Working |
| Table | Working |
| Avatar | Working |
| Descriptions | Working |
| Icons | Working |

### Notes for next developer
- P0-FE-003 (Routing) is the next highest priority task
- P0-FE-004 (Zustand state management) can also be started in parallel
- Semi Design uses CSS variables prefixed with `--semi-color-*`
- For dark mode, Semi Design provides built-in theme switching
- Consider code-splitting Semi Design imports for production optimization
- Toast component works globally without provider setup
---

## 2026-01-23 - P0-FE-003: Route Configuration Complete

### Completed
- **P0-FE-003**: 路由配置 (React Router v6)

### What was done
1. Installed react-router-dom package:
   - `react-router-dom` v7.x for React 19 compatibility

2. Created router infrastructure at `src/router/`:
   - `types.ts` - Type definitions (AppRoute, RouteMeta, MenuItem, BreadcrumbItem)
   - `lazyLoad.tsx` - Lazy loading utilities with Suspense and loading fallback
   - `guards.tsx` - AuthGuard and GuestGuard components for route protection
   - `routes.tsx` - Main route configuration with lazy-loaded pages
   - `index.ts` - Module exports

3. Route features implemented:
   - Lazy loading with React.lazy() and Suspense for code splitting
   - AuthGuard: Redirects unauthenticated users to /login, preserves return URL
   - GuestGuard: Redirects authenticated users away from login
   - Permission checking foundation (ready for P6-FE-003)
   - Breadcrumb generation utility
   - Route metadata support (title, icon, permissions, order)

4. Created placeholder pages:
   - `pages/Dashboard.tsx` - Home dashboard placeholder
   - `pages/Login.tsx` - Login form with mock authentication
   - `pages/NotFound.tsx` - 404 error page
   - `pages/Forbidden.tsx` - 403 access denied page
   - `pages/catalog/Products.tsx`, `pages/catalog/Categories.tsx`
   - `pages/partner/Customers.tsx`, `pages/partner/Suppliers.tsx`, `pages/partner/Warehouses.tsx`
   - `pages/inventory/StockList.tsx`
   - `pages/trade/SalesOrders.tsx`, `pages/trade/PurchaseOrders.tsx`
   - `pages/finance/Receivables.tsx`, `pages/finance/Payables.tsx`

5. Route structure mirrors ERP domain modules:
   ```
   /               - Dashboard (protected)
   /login          - Login page (guest only)
   /catalog/*      - Products, Categories
   /partner/*      - Customers, Suppliers, Warehouses
   /inventory/*    - Stock management
   /trade/*        - Sales, Purchase orders
   /finance/*      - Receivables, Payables
   /403            - Access denied
   /404            - Not found
   ```

6. Updated configuration:
   - Added `@router/*` path alias to vite.config.ts and tsconfig.app.json
   - Updated main.tsx to use createBrowserRouter and RouterProvider

### Files created/modified
- `frontend/package.json` (added react-router-dom)
- `frontend/src/router/types.ts` (new)
- `frontend/src/router/lazyLoad.tsx` (new)
- `frontend/src/router/guards.tsx` (new)
- `frontend/src/router/routes.tsx` (new)
- `frontend/src/router/index.ts` (new)
- `frontend/src/pages/Dashboard.tsx` (new)
- `frontend/src/pages/Login.tsx` (new)
- `frontend/src/pages/NotFound.tsx` (new)
- `frontend/src/pages/Forbidden.tsx` (new)
- `frontend/src/pages/catalog/*.tsx` (new - 2 files)
- `frontend/src/pages/partner/*.tsx` (new - 3 files)
- `frontend/src/pages/inventory/*.tsx` (new - 1 file)
- `frontend/src/pages/trade/*.tsx` (new - 2 files)
- `frontend/src/pages/finance/*.tsx` (new - 2 files)
- `frontend/src/pages/index.ts` (updated)
- `frontend/src/main.tsx` (updated to use router)
- `frontend/vite.config.ts` (added @router alias)
- `frontend/tsconfig.app.json` (added @router alias)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (warnings expected for route config files)
- `npm run build` passes

### Notes for next developer
- P0-FE-004 (Zustand state management) is the next highest priority task
- P0-FE-006 (Layout components) depends on routing and can now be started
- Login page uses mock authentication (stores token in localStorage)
- AuthGuard reads `access_token` from localStorage - integrate with real auth in P6
- Placeholder pages are ready for actual implementation in P1/P2/P3/P4 phases
- Route metadata includes `permissions` field for future permission checks
- Use `lazyLoad()` helper for adding new lazy-loaded routes
- Use `getBreadcrumbs(path)` to generate breadcrumb navigation
- Semi Design illustrations package not compatible with React 19 - using icons instead

---

## 2026-01-23 - P0-FE-004: State Management Configuration (Zustand) Complete

### Completed
- **P0-FE-004**: 状态管理配置 (Zustand)

### What was done
1. Installed Zustand package:
   - `zustand` v5.x for React 19 compatibility

2. Created store directory structure at `src/store/`:
   - `types.ts` - Type definitions (User, AuthState, AuthActions, AppState, AppActions, BreadcrumbItem)
   - `authStore.ts` - Authentication store with persistence
   - `appStore.ts` - Application settings store with persistence
   - `createStore.ts` - Utility for creating stores with auto-selectors
   - `index.ts` - Module exports

3. Implemented Auth Store features:
   - User state (id, username, displayName, permissions, roles)
   - JWT token management (accessToken, refreshToken)
   - Persistent storage using Zustand's persist middleware
   - Permission checking utilities (hasPermission, hasAnyPermission, hasAllPermissions)
   - Login/logout actions
   - Backward compatibility with localStorage for existing guards
   - Devtools integration for debugging

4. Implemented App Store features:
   - Sidebar collapsed state (persistent)
   - Theme switching (light/dark) with Semi Design integration
   - Locale settings (persistent)
   - Page title and breadcrumbs (non-persistent)
   - Devtools integration for debugging

5. Selector hooks for common access patterns:
   - `useUser()`, `useIsAuthenticated()`, `useAuthLoading()` - Auth selectors
   - `useSidebarCollapsed()`, `useTheme()`, `useLocale()`, `useBreadcrumbs()`, `usePageTitle()` - App selectors

6. Updated existing components to use Zustand:
   - `Login.tsx` - Uses `useAuthStore().login()` instead of direct localStorage
   - `Dashboard.tsx` - Displays user info using `useUser()`, logout with `useAuthStore().logout()`
   - `router/guards.tsx` - Uses `useAuthStore()` for authentication and permission checks

### Files created/modified
- `frontend/package.json` (added zustand dependency)
- `frontend/src/store/types.ts` (new)
- `frontend/src/store/authStore.ts` (new)
- `frontend/src/store/appStore.ts` (new)
- `frontend/src/store/createStore.ts` (new)
- `frontend/src/store/index.ts` (updated with exports)
- `frontend/src/pages/Login.tsx` (updated to use auth store)
- `frontend/src/pages/Dashboard.tsx` (updated to show user info and logout)
- `frontend/src/router/guards.tsx` (updated to use auth store)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (warnings from existing route files, not new code)
- `npm run build` passes

### Usage Examples

**Auth Store:**
```tsx
import { useAuthStore, useUser, useIsAuthenticated } from '@/store'

// Get current user
const user = useUser()

// Check if authenticated
const isAuthenticated = useIsAuthenticated()

// Login
const login = useAuthStore((state) => state.login)
login({ id: '1', username: 'admin' }, 'jwt-token')

// Logout
const logout = useAuthStore((state) => state.logout)
logout()

// Check permissions
const { hasPermission, hasAnyPermission } = useAuthStore()
if (hasPermission('products:create')) {
  // User can create products
}
```

**App Store:**
```tsx
import { useAppStore, useTheme, useSidebarCollapsed } from '@/store'

// Get theme
const theme = useTheme()

// Toggle sidebar
const { toggleSidebar, setSidebarCollapsed } = useAppStore()
toggleSidebar()

// Toggle theme
const { toggleTheme, setTheme } = useAppStore()
toggleTheme()
setTheme('dark')

// Set page title (updates document.title)
const { setPageTitle } = useAppStore()
setPageTitle('Products')
```

### Notes for next developer
- P0-FE-006 (Layout components) is the next highest priority task
- P0-FE-007 (Form components) and P0-FE-008 (Table components) can also be started
- Auth store persists to localStorage under key `erp-auth`
- App store persists to localStorage under key `erp-app-settings`
- Theme changes automatically apply `theme-mode` attribute to document body for Semi Design
- Zustand devtools are available in React DevTools for debugging
- Use selector hooks (`useUser()`, `useTheme()`, etc.) for better performance
- The `createStoreWithSelectors` utility can be used for new stores with auto-selectors


---

## 2026-01-23 - P0-FE-006: Layout Components (Header, Sidebar, Content) Complete

### Completed
- **P0-FE-006**: 布局组件 (Header, Sidebar, Content)

### What was done
1. Created MainLayout component at `src/components/layout/MainLayout.tsx`:
   - Wraps protected routes with consistent layout structure
   - Uses React Router's `<Outlet>` for nested route rendering
   - Responsive margin adjustments based on sidebar collapse state

2. Created Sidebar component at `src/components/layout/Sidebar.tsx`:
   - Collapsible sidebar with Semi Design's Nav component
   - Dynamic navigation menu generated from route configuration
   - Active state highlighting based on current path
   - Nested menu support for domain modules
   - Logo area with ERP System branding
   - Collapse button integrated with Zustand app store

3. Created Header component at `src/components/layout/Header.tsx`:
   - Fixed header with breadcrumb navigation
   - Theme toggle (light/dark mode)
   - Notification bell placeholder
   - User avatar with dropdown menu (Profile, Settings, Logout)
   - Responsive design for mobile

4. Updated routes to use layout route pattern:
   - Public routes (login, error pages) render without layout
   - Protected routes wrapped in AuthGuard + MainLayout
   - Cleaner route configuration with metadata-driven approach

5. Added CSS variables for layout dimensions in `index.css`:
   - `--header-height: 60px`
   - `--sidebar-width: 220px`
   - `--sidebar-collapsed-width: 60px`

6. Updated Dashboard page:
   - Removed logout button (now in header)
   - Added statistics cards with icons
   - Added quick action buttons

### Files created/modified
- `frontend/src/components/layout/MainLayout.tsx` (new)
- `frontend/src/components/layout/MainLayout.css` (new)
- `frontend/src/components/layout/Sidebar.tsx` (new)
- `frontend/src/components/layout/Sidebar.css` (new)
- `frontend/src/components/layout/Header.tsx` (new)
- `frontend/src/components/layout/Header.css` (new)
- `frontend/src/components/layout/index.ts` (updated with exports)
- `frontend/src/router/routes.tsx` (updated to use MainLayout)
- `frontend/src/pages/Dashboard.tsx` (updated UI)
- `frontend/src/index.css` (added CSS variables)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (warnings expected for lazy-loaded routes)
- `npm run build` passes

### Layout Structure
```
+----------------------------------+
|          Header (fixed)          |
+--------+-------------------------+
|        |                         |
| Side-  |       Content           |
| bar    |       (Outlet)          |
| (fixed)|                         |
|        |                         |
+--------+-------------------------+
```

### Key Features
- Sidebar collapse persists via Zustand (localStorage)
- Theme toggle applies `theme-mode` attribute for Semi Design
- Breadcrumbs auto-generated from route path
- User dropdown with profile, settings, logout options
- Responsive design with mobile breakpoints

### Notes for next developer
- P0-FE-007 (Form components) is the next highest priority task
- P0-FE-008 (Table components) can also be started
- To add new pages, simply add route to appRoutes and corresponding page component
- Sidebar navigation auto-updates from route configuration
- Use `getBreadcrumbs(path)` utility for custom breadcrumb generation
- Semi Design Nav uses `isCollapsed` prop, not CSS for collapse state



---

## 2026-01-23 - P0-FE-007: Common Form Components Complete

### Completed
- **P0-FE-007**: 通用表单组件

### What was done
1. Installed form dependencies:
   - `react-hook-form` v7.71.1 - Form state management
   - `zod` v4.3.6 - Schema validation
   - `@hookform/resolvers` v5.2.2 - Zod resolver for react-hook-form

2. Created form components at `src/components/common/form/`:
   - `TextField.tsx` - Text input field with validation
   - `NumberField.tsx` - Number input field with min/max/precision
   - `TextAreaField.tsx` - Multi-line text field with character count
   - `SelectField.tsx` - Dropdown select with search support
   - `DateField.tsx` - Date picker with multiple output formats (ISO string, Date, timestamp)
   - `CheckboxField.tsx` - Single checkbox with label
   - `CheckboxGroupField.tsx` - Multiple checkboxes for multi-select
   - `RadioGroupField.tsx` - Radio button group with button/card styles
   - `SwitchField.tsx` - Toggle switch with custom text
   - `TreeSelectField.tsx` - Hierarchical tree select for categories

3. Created form layout components:
   - `Form.tsx` - Form wrapper with loading spinner
   - `FormActions.tsx` - Submit/Cancel button bar with alignment options
   - `FormSection.tsx` - Grouped form sections with title/description
   - `FormRow.tsx` - Grid-based multi-column field layout (1-4 columns)
   - `FormFieldWrapper.tsx` - Consistent label/error/helper styling

4. Created form utilities:
   - `useFormWithValidation.ts` - Custom hook wrapping react-hook-form with:
     - Zod schema validation integration
     - Server-side error handling
     - Toast notifications on success/error
     - Reset on success option
   - `validation.ts` - Pre-built validation schemas and helpers:
     - Common validation messages (Chinese localized)
     - Regex patterns (phone, SKU, barcode, etc.)
     - Pre-built schemas (email, phone, money, quantity, etc.)
     - Schema factory functions (createStringSchema, createNumberSchema, createEnumSchema)
     - Coercion helpers for form inputs

5. Created TypeScript types:
   - `types.ts` - Shared types for controlled fields, options, form config

### Files created
- `frontend/src/components/common/form/types.ts`
- `frontend/src/components/common/form/validation.ts`
- `frontend/src/components/common/form/FormFieldWrapper.tsx`
- `frontend/src/components/common/form/FormFieldWrapper.css`
- `frontend/src/components/common/form/TextField.tsx`
- `frontend/src/components/common/form/NumberField.tsx`
- `frontend/src/components/common/form/TextAreaField.tsx`
- `frontend/src/components/common/form/SelectField.tsx`
- `frontend/src/components/common/form/DateField.tsx`
- `frontend/src/components/common/form/CheckboxField.tsx`
- `frontend/src/components/common/form/RadioGroupField.tsx`
- `frontend/src/components/common/form/SwitchField.tsx`
- `frontend/src/components/common/form/TreeSelectField.tsx`
- `frontend/src/components/common/form/Form.tsx`
- `frontend/src/components/common/form/Form.css`
- `frontend/src/components/common/form/useFormWithValidation.ts`
- `frontend/src/components/common/form/index.ts`
- `frontend/src/components/common/index.ts` (updated)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (only warnings from existing route files)
- `npm run build` passes

### Usage Examples

**Basic form with validation:**
```tsx
import { z } from 'zod'
import { useFormWithValidation, Form, FormActions, FormRow, TextField, NumberField, SelectField } from '@/components/common'

const schema = z.object({
  name: z.string().min(1, '名称为必填项'),
  price: z.number().positive('价格必须为正数'),
  category: z.string().min(1, '请选择分类'),
})

type FormData = z.infer<typeof schema>

function ProductForm() {
  const { control, handleFormSubmit, isSubmitting } = useFormWithValidation<FormData>({
    schema,
    successMessage: '保存成功',
  })

  const onSubmit = async (data: FormData) => {
    await api.createProduct(data)
  }

  return (
    <Form onSubmit={handleFormSubmit(onSubmit)} isSubmitting={isSubmitting}>
      <FormRow cols={2}>
        <TextField name="name" control={control} label="名称" required />
        <NumberField name="price" control={control} label="价格" min={0} precision={2} required />
      </FormRow>
      <SelectField
        name="category"
        control={control}
        label="分类"
        options={[
          { label: '电子产品', value: 'electronics' },
          { label: '服装', value: 'clothing' },
        ]}
        required
      />
      <FormActions isSubmitting={isSubmitting} onCancel={() => navigate(-1)} />
    </Form>
  )
}
```

### Notes for next developer
- P0-FE-008 (Table components) is the next highest priority task
- P0-FE-009 (Vitest testing) can also be started
- All form fields use Semi Design components under the hood
- Zod 4.x has a slightly different API than Zod 3 - use `message` instead of `invalid_type_error` for number schemas
- The `useFormWithValidation` hook handles server-side validation errors automatically if API returns `details` array
- Use `schemas.*` for common field types (email, phone, money, etc.)
- Use `patterns.*` for regex patterns (phone, SKU, barcode, etc.)
- Form fields support `labelPosition` ('top', 'left', 'inset') for different layouts
- TreeSelectField is ready for category hierarchies in P1-FE-003



---

## 2026-01-24 - P0-FE-DS: Frontend Design System Complete

### Completed
- **P0-FE-DS**: 前端设计规范体系 (Design System)

### What was done
1. Created comprehensive design token system at `src/styles/tokens/`:
   - `breakpoints.css` - Responsive breakpoint system (375px/768px/1024px/1440px)
   - `colors.css` - Color palette with semantic tokens, dark mode, and elder-friendly theme support
   - `spacing.css` - 4px-based spacing scale with component-specific spacing
   - `typography.css` - Font families, sizes, weights, line heights with font scaling
   - `shadows.css` - Elevation shadow system with dark mode variants
   - `animations.css` - Duration, easing, and keyframe animations with reduced motion support

2. Created accessibility utilities at `src/styles/accessibility.css`:
   - Focus management (:focus-visible, focus-within)
   - Skip links for keyboard navigation
   - Screen reader utilities (sr-only, aria-live)
   - High contrast mode support (@media prefers-contrast)
   - Forced colors mode support (Windows High Contrast)
   - Touch target sizing (44x44px minimum)
   - Color blind safe status indicators

3. Created responsive layout components at `src/components/common/layout/`:
   - `Container.tsx` - Responsive centered container with configurable max-widths
   - `Grid.tsx` - CSS Grid component with responsive column support and GridItem
   - `Flex.tsx` - Flexbox utilities including Stack, Row, Spacer, and Divider components

4. Created theme management hooks at `src/hooks/useTheme.ts`:
   - `useThemeManager()` - Theme switching (light/dark/elder)
   - `useFontScale()` - Font scaling for accessibility
   - `useAccessibilityPreferences()` - Detect reduced motion and high contrast preferences
   - System theme detection and auto-switching

5. Created responsive grid CSS utilities at `src/styles/utilities/grid.css`:
   - Responsive grid column classes for all breakpoints
   - Mobile-first approach

6. Updated frontend/README.md with comprehensive design system documentation:
   - Technology stack overview
   - Responsive design guidelines and breakpoints
   - CSS architecture and conventions
   - Design tokens reference (colors, spacing, typography, shadows, animations)
   - Layout component usage examples
   - Theme system documentation
   - Accessibility (WCAG 2.1 AA) requirements and utilities
   - Interaction design principles
   - Component guidelines and best practices
   - File structure reference

7. Updated root CLAUDE.md:
   - Added reference to frontend/README.md as required reading
   - Added frontend development guidelines section
   - Emphasized design token usage, responsive design, and accessibility requirements

### Files created
- `frontend/src/styles/tokens/breakpoints.css`
- `frontend/src/styles/tokens/colors.css`
- `frontend/src/styles/tokens/spacing.css`
- `frontend/src/styles/tokens/typography.css`
- `frontend/src/styles/tokens/shadows.css`
- `frontend/src/styles/tokens/animations.css`
- `frontend/src/styles/tokens/index.css`
- `frontend/src/styles/accessibility.css`
- `frontend/src/styles/utilities/grid.css`
- `frontend/src/styles/index.css`
- `frontend/src/components/common/layout/Container.tsx`
- `frontend/src/components/common/layout/Grid.tsx`
- `frontend/src/components/common/layout/Flex.tsx`
- `frontend/src/components/common/layout/index.ts`
- `frontend/src/hooks/useTheme.ts`

### Files modified
- `frontend/src/main.tsx` (imports design system styles)
- `frontend/src/hooks/index.ts` (exports theme hooks)
- `frontend/src/components/common/index.ts` (exports layout components)
- `frontend/vite.config.ts` (added @styles alias)
- `frontend/tsconfig.app.json` (added @styles path alias)
- `frontend/README.md` (complete rewrite with design system documentation)
- `CLAUDE.md` (added frontend guidelines and README reference)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (only warnings from existing router files)
- `npm run build` passes

### Design System Summary

| Feature | Implementation |
|---------|----------------|
| Breakpoints | Mobile 375px / Tablet 768px / Desktop 1024px / Wide 1440px |
| CSS Architecture | CSS Variables + CSS Modules + BEM naming |
| Color Tokens | 10-level scales for primary/success/warning/danger/neutral |
| Spacing | 4px grid system with component-specific tokens |
| Typography | rem-based font sizes with 4 scale levels |
| Shadows | 5-level elevation system |
| Animations | Duration/easing tokens with reduced motion support |
| Themes | Light, Dark, Elder-friendly |
| Accessibility | WCAG 2.1 AA, focus management, screen reader support |
| Layout Components | Container, Grid, GridItem, Flex, Stack, Row, Spacer, Divider |

### Usage Examples

```tsx
// Layout with responsive grid
import { Container, Grid, Stack, Row, Spacer } from '@/components/common'

<Container size="lg">
  <Grid cols={{ mobile: 1, tablet: 2, desktop: 4 }} gap="md">
    <Card>Item 1</Card>
    <Card>Item 2</Card>
  </Grid>
</Container>

// Theme management
import { useThemeManager, useFontScale } from '@/hooks'

const { theme, setTheme } = useThemeManager()
const { fontScale, setFontScale } = useFontScale()
```

### Notes for next developer
- P0-FE-008 (Table components) is the next highest priority task
- P0-FE-009 (Vitest testing) can also be started
- Always use design tokens via CSS variables (e.g., `--spacing-4`, `--color-primary`)
- Test components in all three themes (light, dark, elder)
- Layout components (Container, Grid, Flex) should be used for all page layouts
- Accessibility utilities (`sr-only`, `skip-link`, etc.) are available globally
- Font scaling works via `data-font-scale` attribute on `<html>` element
- Reduced motion is automatically respected via CSS `prefers-reduced-motion` media query


---

## 2026-01-24 - P0-FE-008: Common Table Components Complete

### Completed
- **P0-FE-008**: 通用表格组件

### What was done
1. Created comprehensive table component system at `src/components/common/table/`:
   - `types.ts` - Type definitions for DataTable, columns, actions, filters, sorting
   - `useTableState.ts` - Hook for managing pagination, sorting, and filtering state
   - `DataTable.tsx` - Main table component based on Semi Design Table
   - `DataTable.css` - Styles following design system tokens
   - `TableActions.tsx` - Row action buttons with dropdown overflow and confirmation support
   - `TableActions.css` - Action button styles
   - `TableToolbar.tsx` - Search, filters, and action buttons toolbar
   - `TableToolbar.css` - Toolbar styles
   - `index.ts` - Module exports

2. DataTable features implemented:
   - Server-side pagination with configurable page sizes
   - Column sorting (click to toggle asc/desc/none)
   - Row selection with checkbox/radio support
   - Row actions with automatic overflow to dropdown menu
   - Confirmation dialogs for dangerous actions
   - Loading state with spinner overlay
   - Empty state with customizable content
   - Sticky header support
   - Resizable columns
   - Expandable rows

3. useTableState hook features:
   - Manages pagination, sort, and filter state
   - Resets to page 1 when sort/filter changes
   - `toApiParams()` converts state to API request parameters
   - `handleStateChange()` for controlled updates from DataTable

4. TableToolbar component:
   - Search input with debounce support
   - Primary action button (e.g., "Add New")
   - Secondary action buttons
   - Filter slot for custom filter components
   - Bulk action bar when rows are selected

5. TableActions component:
   - Direct action buttons (up to 3 visible by default)
   - Overflow dropdown for additional actions
   - Popconfirm for actions requiring confirmation
   - Modal fallback for dropdown items with confirmation
   - Supports disabled/hidden states per record

### Files created
- `frontend/src/components/common/table/types.ts`
- `frontend/src/components/common/table/useTableState.ts`
- `frontend/src/components/common/table/DataTable.tsx`
- `frontend/src/components/common/table/DataTable.css`
- `frontend/src/components/common/table/TableActions.tsx`
- `frontend/src/components/common/table/TableActions.css`
- `frontend/src/components/common/table/TableToolbar.tsx`
- `frontend/src/components/common/table/TableToolbar.css`
- `frontend/src/components/common/table/index.ts`

### Files modified
- `frontend/src/components/common/index.ts` (added table exports)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (only pre-existing warnings)
- `npm run build` passes

### Usage Examples

**Basic DataTable:**
```tsx
import { DataTable, useTableState, DataTableColumn, TableAction } from '@/components/common'

interface Product {
  id: string
  name: string
  sku: string
  price: number
  status: 'active' | 'inactive'
}

const columns: DataTableColumn<Product>[] = [
  { title: '商品名称', dataIndex: 'name', sortable: true },
  { title: 'SKU', dataIndex: 'sku', width: 120 },
  { title: '价格', dataIndex: 'price', align: 'right', sortable: true },
  { title: '状态', dataIndex: 'status', render: (status) => <StatusTag status={status} /> },
]

const actions: TableAction<Product>[] = [
  { key: 'edit', label: '编辑', onClick: (record) => handleEdit(record) },
  {
    key: 'delete',
    label: '删除',
    type: 'danger',
    onClick: (record) => handleDelete(record),
    confirm: { title: '确认删除', content: '删除后无法恢复' },
  },
]

function ProductList() {
  const { state, handleStateChange, toApiParams } = useTableState({
    defaultPageSize: 20,
    defaultSortField: 'created_at',
    defaultSortOrder: 'desc',
  })

  const { data, isLoading } = useQuery(['products', toApiParams()], () =>
    fetchProducts(toApiParams())
  )

  return (
    <DataTable
      data={data?.data || []}
      columns={columns}
      rowKey="id"
      loading={isLoading}
      pagination={data?.meta}
      actions={actions}
      onStateChange={handleStateChange}
      sortState={state.sort}
    />
  )
}
```

**With TableToolbar:**
```tsx
import { TableToolbar, BulkActionBar, DataTable } from '@/components/common'

function ProductListPage() {
  const [selectedRowKeys, setSelectedRowKeys] = useState<string[]>([])

  return (
    <div>
      <TableToolbar
        searchValue={keyword}
        onSearchChange={setKeyword}
        searchPlaceholder="搜索商品名称、SKU..."
        primaryAction={{
          label: '新增商品',
          onClick: () => navigate('/catalog/products/new'),
        }}
      />

      {selectedRowKeys.length > 0 && (
        <BulkActionBar
          selectedCount={selectedRowKeys.length}
          onCancel={() => setSelectedRowKeys([])}
        >
          <Button onClick={handleBulkEnable}>批量启用</Button>
          <Button type="danger" onClick={handleBulkDelete}>批量删除</Button>
        </BulkActionBar>
      )}

      <DataTable
        data={products}
        columns={columns}
        rowKey="id"
        rowSelection={{
          selectedRowKeys,
          onChange: setSelectedRowKeys,
        }}
      />
    </div>
  )
}
```

### Notes for next developer
- P0-FE-009 (Vitest testing) is the next highest priority task
- P1-FE-001 (Product list page) can now use these table components
- All table components follow the design system tokens from `src/styles/tokens/`
- DataTable requires `rowKey` prop (string field name or function)
- Use `useTableState` hook for server-side pagination/sorting
- Actions with `confirm` property show Popconfirm before executing
- For large datasets, enable `sticky` prop for sticky header
- Row selection uses string[] for selectedRowKeys (convert from API if needed)


---

## 2026-01-24 - P0-FE-009: Frontend Test Framework Configuration (Vitest) Complete

### Completed
- **P0-FE-009**: 前端测试框架配置 (Vitest)

### What was done
1. Installed testing dependencies:
   - `vitest` v4.x - Test runner compatible with Vite
   - `@testing-library/react` v16.x - React component testing utilities
   - `@testing-library/jest-dom` v6.x - Custom DOM matchers
   - `@testing-library/user-event` v14.x - User interaction simulation
   - `@vitest/coverage-v8` v4.x - Code coverage with V8 provider
   - `jsdom` v27.x - DOM environment for tests

2. Configured Vitest in `vite.config.ts`:
   - Using `vitest/config` for proper TypeScript support
   - JSDOM environment for browser-like testing
   - Global test APIs (describe, it, expect)
   - Coverage configuration with 80% threshold
   - Proper exclusions for auto-generated files and test files

3. Created test setup at `src/tests/setup.ts`:
   - Jest-DOM matchers integration
   - Auto-cleanup after each test
   - Browser API mocks (matchMedia, ResizeObserver, IntersectionObserver)
   - Storage mocks (localStorage, sessionStorage)
   - Console suppression for cleaner test output

4. Created test utilities at `src/tests/`:
   - `utils.tsx` - Custom render functions with providers:
     - `renderWithProviders()` - Renders with Router context
     - `renderWithUser()` - Renders with user-event setup
     - Mock API response helpers (success, error, paginated)
   - `index.ts` - Re-exports for convenient importing

5. Added path alias `@tests/*` in both Vite and TypeScript configs

6. Added npm scripts:
   - `npm run test` - Interactive watch mode
   - `npm run test:run` - Single run for CI
   - `npm run test:ui` - Vitest UI (requires @vitest/ui)
   - `npm run test:coverage` - Run with coverage report
   - `npm run test:watch` - Watch mode

7. Created example tests:
   - `src/store/authStore.test.ts` - 10 tests for Zustand auth store
   - `src/components/common/form/validation.test.ts` - 27 tests for validation schemas
   - `src/tests/utils.test.tsx` - 12 tests for test utilities

### Files created/modified
- `frontend/package.json` (added test dependencies and scripts)
- `frontend/vite.config.ts` (added Vitest configuration)
- `frontend/tsconfig.app.json` (added vitest types and @tests alias)
- `frontend/src/tests/setup.ts` (new)
- `frontend/src/tests/utils.tsx` (new)
- `frontend/src/tests/index.ts` (new)
- `frontend/src/tests/utils.test.tsx` (new)
- `frontend/src/store/authStore.test.ts` (new)
- `frontend/src/components/common/form/validation.test.ts` (new)

### Build Status
- `npm run type-check` passes
- `npm run lint` passes (only pre-existing warnings)
- `npm run build` passes
- `npm run test:run` passes (49 tests)

### Test Statistics
| Test File | Tests |
|-----------|-------|
| authStore.test.ts | 10 |
| validation.test.ts | 27 |
| utils.test.tsx | 12 |
| **Total** | **49** |

### Usage Examples

**Running tests:**
```bash
npm run test           # Interactive watch mode
npm run test:run       # Single run (CI)
npm run test:coverage  # With coverage report
```

**Writing a component test:**
```tsx
import { describe, it, expect } from 'vitest'
import { renderWithProviders, screen, waitFor } from '@tests'

describe('MyComponent', () => {
  it('should render correctly', async () => {
    const { user } = renderWithProviders(<MyComponent />)
    
    expect(screen.getByText('Hello')).toBeInTheDocument()
    
    await user.click(screen.getByRole('button'))
    
    await waitFor(() => {
      expect(screen.getByText('Clicked!')).toBeInTheDocument()
    })
  })
})
```

**Writing a store test:**
```tsx
import { describe, it, expect, beforeEach } from 'vitest'
import { act } from '@testing-library/react'
import { useMyStore } from '@store/myStore'

describe('useMyStore', () => {
  beforeEach(() => {
    // Reset store state
    act(() => {
      useMyStore.getState().reset()
    })
  })

  it('should update state', () => {
    act(() => {
      useMyStore.getState().setValue('test')
    })
    
    expect(useMyStore.getState().value).toBe('test')
  })
})
```

### Notes for next developer
- All P0 frontend tasks are now complete (except prototype design tasks P0-PD-*)
- P1-FE-* tasks (Product/Partner features) can now begin
- Use `@tests` import alias for test utilities
- Run `npm run test:coverage` to check coverage (80% threshold enforced)
- Browser API mocks are pre-configured in setup.ts
- For async tests, use `waitFor()` instead of `setTimeout()`
- Storage mocks reset before each test automatically

---

## 2026-01-24 - P1-BE-001: Category Aggregate Implementation Complete

### Completed
- **P1-BE-001**: Category 聚合实现

### What was done
1. Created Category aggregate root at `internal/domain/catalog/category.go`:
   - `Category` struct with TenantAggregateRoot embedding for multi-tenant support
   - Tree structure using materialized path pattern (`path` field stores ancestor chain)
   - `NewCategory()` - Creates root category
   - `NewChildCategory()` - Creates child category under a parent
   - `Update()`, `UpdateCode()` - Updates category information
   - `Activate()`, `Deactivate()` - Status management
   - `SetSortOrder()` - Display order management
   - `IsRoot()`, `IsActive()` - State queries
   - `GetAncestorIDs()`, `IsAncestorOf()`, `IsDescendantOf()` - Tree traversal helpers
   - Maximum depth enforcement (5 levels)
   - Validation for code (alphanumeric + underscore/hyphen) and name

2. Created domain events at `internal/domain/catalog/category_events.go`:
   - `CategoryCreatedEvent` - Published when category is created
   - `CategoryUpdatedEvent` - Published when category is updated
   - `CategoryStatusChangedEvent` - Published on activate/deactivate
   - `CategoryDeletedEvent` - For deletion tracking

3. Created repository interface at `internal/domain/catalog/category_repository.go`:
   - `CategoryRepository` interface with methods for:
     - CRUD operations (`FindByID`, `FindByCode`, `Save`, `Delete`)
     - Tree queries (`FindChildren`, `FindRootCategories`, `FindDescendants`)
     - Multi-tenant support (`FindByIDForTenant`, `FindAllForTenant`)
     - Existence checks (`ExistsByCode`, `HasChildren`, `HasProducts`)
     - Path management (`UpdatePath` for moving categories)

4. Created GORM repository implementation at `internal/infrastructure/persistence/category_repository.go`:
   - `GormCategoryRepository` implementing `CategoryRepository`
   - Full CRUD with tenant scoping
   - Tree operations using materialized path queries
   - Filter support (search, status, parent_id, level)
   - Pagination and ordering

5. Created database migration:
   - `migrations/000003_create_categories.up.sql`
     - Categories table with tenant_id, code, name, parent_id, path, level, sort_order, status
     - Indexes for efficient tree and tenant queries
     - Check constraints for status and level
     - Unique constraint on (tenant_id, code)
   - `migrations/000003_create_categories.down.sql` - Rollback script

6. Created comprehensive unit tests at `internal/domain/catalog/category_test.go`:
   - 38 test cases covering all category functionality
   - Tests for creation, updates, status changes
   - Tests for tree structure (parent-child, ancestors, descendants)
   - Tests for validation (code, name)
   - Tests for domain events

### Files created
- `backend/internal/domain/catalog/category.go`
- `backend/internal/domain/catalog/category_events.go`
- `backend/internal/domain/catalog/category_repository.go`
- `backend/internal/domain/catalog/category_test.go`
- `backend/internal/infrastructure/persistence/category_repository.go`
- `backend/migrations/000003_create_categories.up.sql`
- `backend/migrations/000003_create_categories.down.sql`

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (38 new tests in catalog package)

### Key Design Decisions
1. **Materialized Path**: Uses `/`-separated UUID path for efficient tree queries
   - Example: `parentID/childID/grandchildID`
   - Supports prefix matching for descendant queries
   - Updates require path propagation to descendants
2. **Max Depth**: 5 levels to prevent overly deep hierarchies
3. **Code Uniqueness**: Unique per tenant, stored in uppercase
4. **Optimistic Locking**: Version field for concurrent update handling
5. **Soft Status**: Active/Inactive instead of hard delete for data integrity

### Usage Examples
```go
// Create root category
electronics, _ := catalog.NewCategory(tenantID, "ELECTRONICS", "Electronics")

// Create child category
phones, _ := catalog.NewChildCategory(tenantID, "PHONES", "Phones", electronics)

// Update category
phones.Update("Smartphones", "All smartphone products")

// Status management
phones.Deactivate()
phones.Activate()

// Tree queries
ancestors := phones.GetAncestorIDs()       // [electronics.ID]
isChild := electronics.IsAncestorOf(phones) // true
```

### Notes for next developer
- P1-BE-002 (Product aggregate) can now be started - it depends on Category
- Category code is automatically uppercased on creation/update
- Path format: `uuid1/uuid2/uuid3` (no leading or trailing slash)
- Repository's `HasProducts()` returns false until Product is implemented
- Run `./bin/migrate up` to apply the categories migration
- For moving categories to new parent, use `UpdatePath()` method


---

## 2026-01-24 - P1-BE-002: Product Aggregate Root Implementation Complete

### Completed
- **P1-BE-002**: Product 聚合根实现

### What was done
1. Created Product aggregate root at `internal/domain/catalog/product.go`:
   - `Product` struct extending `TenantAggregateRoot` for multi-tenant support
   - Fields: Code, Name, Description, Barcode, CategoryID, Unit, PurchasePrice, SellingPrice, MinStock, Status, SortOrder, Attributes
   - `NewProduct()` - Factory for creating products with validation
   - `NewProductWithPrices()` - Factory with prices
   - `Update()`, `UpdateCode()`, `SetBarcode()`, `SetCategory()` - Basic updates
   - `SetPrices()`, `UpdatePurchasePrice()`, `UpdateSellingPrice()` - Price management
   - `SetMinStock()`, `SetSortOrder()`, `SetAttributes()` - Additional settings
   - `Activate()`, `Deactivate()`, `Discontinue()` - Status management (three states: active/inactive/discontinued)
   - `GetProfitMargin()`, `GetPurchasePriceMoney()`, `GetSellingPriceMoney()` - Business calculations
   - Validation for code (alphanumeric + underscore/hyphen), name (max 200 chars), unit (max 20 chars)

2. Created domain events at `internal/domain/catalog/product_events.go`:
   - `ProductCreatedEvent` - Published on creation
   - `ProductUpdatedEvent` - Published on updates
   - `ProductStatusChangedEvent` - Published on status changes
   - `ProductPriceChangedEvent` - Published on price changes
   - `ProductDeletedEvent` - For deletion tracking
   - All events embed `BaseDomainEvent` with tenant support

3. Created ProductRepository interface at `internal/domain/catalog/product_repository.go`:
   - Standard CRUD: `FindByID`, `FindByIDForTenant`, `Save`, `Delete`, `DeleteForTenant`
   - Query methods: `FindByCode`, `FindByBarcode`, `FindAll`, `FindAllForTenant`
   - Category queries: `FindByCategory`, `FindByCategories`
   - Status queries: `FindActive`, `FindByStatus`
   - Batch operations: `FindByIDs`, `FindByCodes`, `SaveBatch`
   - Count methods: `Count`, `CountForTenant`, `CountByCategory`, `CountByStatus`
   - Existence checks: `ExistsByCode`, `ExistsByBarcode`

4. Created GORM repository implementation at `internal/infrastructure/persistence/product_repository.go`:
   - Full implementation of ProductRepository interface
   - Tenant scoping on all queries
   - Filter support: search (name/code/barcode), status, category_id, unit, min_price, max_price, has_barcode
   - Pagination and ordering support
   - Default ordering by sort_order, name

5. Created database migration `000004_create_products`:
   - Products table with tenant foreign key
   - Composite unique index on (tenant_id, code)
   - Foreign key to categories
   - Decimal fields for prices (18,4 precision)
   - JSONB for custom attributes
   - Indexes for efficient querying (tenant, category, barcode, status)
   - Trigger for updated_at timestamp

6. Comprehensive unit tests at `internal/domain/catalog/product_test.go`:
   - 67 test cases covering all Product functionality
   - Tests for creation, updates, status changes
   - Tests for price management
   - Tests for validation (code, name, unit)
   - Tests for domain events
   - Tests for business calculations (profit margin)

### Files created
- `backend/internal/domain/catalog/product.go`
- `backend/internal/domain/catalog/product_events.go`
- `backend/internal/domain/catalog/product_repository.go`
- `backend/internal/domain/catalog/product_test.go`
- `backend/internal/infrastructure/persistence/product_repository.go`
- `backend/migrations/000004_create_products.up.sql`
- `backend/migrations/000004_create_products.down.sql`

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (67 new tests in product)

### Key Design Decisions
1. **Three-state status**: Active, Inactive, Discontinued (discontinued cannot be reactivated)
2. **Decimal prices**: Using `decimal.Decimal` for precision, 4 decimal places in DB
3. **JSONB attributes**: Flexible custom attributes stored as JSON
4. **Code normalization**: Codes stored uppercase for consistency
5. **Category reference**: Soft reference to Category (SET NULL on delete)

### Usage Examples
```go
// Create product
product, _ := catalog.NewProduct(tenantID, "SKU-001", "Widget", "pcs")

// Set prices
purchasePrice := valueobject.NewMoneyCNYFromFloat(50.00)
sellingPrice := valueobject.NewMoneyCNYFromFloat(100.00)
product.SetPrices(purchasePrice, sellingPrice)

// Set category
product.SetCategory(&categoryID)

// Status management
product.Deactivate()
product.Activate()
product.Discontinue() // Cannot reactivate after this

// Calculate profit margin
margin := product.GetProfitMargin() // 100% for (100-50)/50*100
```

### Notes for next developer
- P1-BE-003 (Product Repository) is also done as part of this task
- P1-BE-004 (Product Application Service) can now be started
- P1-BE-007 (Product domain events) is also done as part of this task
- Product code is automatically uppercased on creation/update
- Use `NewProductWithPrices()` when you need to set prices during creation
- Discontinued products cannot be activated or deactivated
- Repository implements interface check: `var _ catalog.ProductRepository = (*GormProductRepository)(nil)`
- Run `./bin/migrate up` to apply the products migration



---

## 2026-01-24 - P1-BE-004: Product Application Service Complete

### Completed
- **P1-BE-004**: Product Application Service
- **P1-BE-003**: Product Repository 接口 + 实现 (was already done in P1-BE-002, marking as complete)
- **P1-BE-007**: Product 领域事件发布 (was already done in P1-BE-002, marking as complete)

### What was done
1. Created application service directory structure at `internal/application/catalog/`

2. Created product DTOs at `internal/application/catalog/dto.go`:
   - `CreateProductRequest` - Request for creating new products
   - `UpdateProductRequest` - Request for updating products (partial updates)
   - `UpdateProductCodeRequest` - Request for changing product code
   - `ProductResponse` - Full product response with all fields including profit margin
   - `ProductListResponse` - Simplified response for list views
   - `ProductListFilter` - Filter options for product listing
   - Converter functions: `ToProductResponse()`, `ToProductListResponse()`, `ToProductListResponses()`

3. Created Product Application Service at `internal/application/catalog/product_service.go`:
   - `ProductService` struct with ProductRepository and CategoryRepository dependencies
   - `Create()` - Create product with validation (duplicate code/barcode, category existence)
   - `GetByID()` - Get product by ID for tenant
   - `GetByCode()` - Get product by code for tenant
   - `List()` - List products with filtering, pagination, and sorting
   - `Update()` - Partial update of product fields
   - `UpdateCode()` - Update product code with duplicate check
   - `Delete()` - Delete product (with existence check)
   - `Activate()` - Activate inactive product
   - `Deactivate()` - Deactivate active product
   - `Discontinue()` - Discontinue product (cannot be reactivated)
   - `GetByCategory()` - Get products by category ID
   - `CountByStatus()` - Get product counts grouped by status

4. Created comprehensive unit tests at `internal/application/catalog/product_service_test.go`:
   - 23 test cases covering all service methods
   - Mock implementations for ProductRepository and CategoryRepository
   - Tests for success cases, validation errors, and domain errors
   - Tests for status transitions and business rules

### Files created
- `backend/internal/application/catalog/dto.go`
- `backend/internal/application/catalog/product_service.go`
- `backend/internal/application/catalog/product_service_test.go`

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (23 new tests in application/catalog package)

### Key Design Decisions
1. **Separate DTOs from Domain**: Application layer has its own DTOs to decouple from domain models
2. **Tenant Scoping**: All operations are scoped to tenant ID from context
3. **Validation at Service Level**: Business rule validation (duplicate code/barcode, category existence) in service
4. **Partial Updates**: UpdateProductRequest uses pointers for optional fields
5. **Repository Injection**: Service depends on interfaces, not implementations (DI ready)

### Usage Examples
```go
// Create service
productRepo := persistence.NewGormProductRepository(db)
categoryRepo := persistence.NewGormCategoryRepository(db)
productService := catalog.NewProductService(productRepo, categoryRepo)

// Create product
req := catalog.CreateProductRequest{
    Code: "SKU-001",
    Name: "Widget",
    Unit: "pcs",
    PurchasePrice: decimal.NewFromFloat(50.00),
    SellingPrice: decimal.NewFromFloat(100.00),
}
product, err := productService.Create(ctx, tenantID, req)

// List products with filters
filter := catalog.ProductListFilter{
    Search:   "widget",
    Status:   "active",
    Page:     1,
    PageSize: 20,
}
products, total, err := productService.List(ctx, tenantID, filter)

// Update product
updateReq := catalog.UpdateProductRequest{
    Name: stringPtr("Updated Widget"),
}
updated, err := productService.Update(ctx, tenantID, productID, updateReq)

// Status changes
_, err = productService.Deactivate(ctx, tenantID, productID)
_, err = productService.Activate(ctx, tenantID, productID)
_, err = productService.Discontinue(ctx, tenantID, productID)
```

### Notes for next developer
- P1-BE-005 (Product API) can now be started - service layer is ready
- Application service handles validation and orchestration
- Domain events are already published by the domain layer (P1-BE-002)
- Use the DTOs for HTTP request/response handling
- Service methods return domain errors which can be converted to HTTP errors using handlers


---

## 2026-01-24 - P1-BE-005: Product API (CRUD + enable/disable) Complete

### Completed
- **P1-BE-005**: Product API (CRUD + enable/disable)

### What was done
1. Created Product HTTP handler at `internal/interfaces/http/handler/product.go`:
   - Full CRUD operations: Create, GetByID, GetByCode, List, Update, UpdateCode, Delete
   - Status management: Activate, Deactivate, Discontinue
   - Utility endpoints: CountByStatus, GetByCategory
   - Complete Swagger/OpenAPI annotations for all endpoints

2. Created Swagger-friendly DTOs at `internal/interfaces/http/handler/product_dto.go`:
   - `ProductResponse` with swagger example annotations
   - `ProductListResponse` for list views
   - `ProductListItem` for paginated responses

3. Created helper functions at `internal/interfaces/http/handler/helpers.go`:
   - `toDecimalPtr()` - Convert float64 to *decimal.Decimal
   - `toDecimal()` - Convert float64 to decimal.Decimal

4. Registered routes in `cmd/server/main.go`:
   - Initialized repositories (product, category)
   - Initialized ProductService with dependencies
   - Initialized ProductHandler
   - Registered all routes under `/api/v1/catalog/products`

5. Regenerated OpenAPI documentation:
   - `backend/docs/swagger.yaml`
   - `backend/docs/swagger.json`
   - `backend/docs/docs.go`

6. Created comprehensive unit tests at `internal/interfaces/http/handler/product_test.go`:
   - 17 test cases covering all handler methods
   - Mock implementations for ProductRepository and CategoryRepository
   - Tests for success cases, validation errors, not found errors

### Files created
- `backend/internal/interfaces/http/handler/product.go`
- `backend/internal/interfaces/http/handler/product_dto.go`
- `backend/internal/interfaces/http/handler/helpers.go`
- `backend/internal/interfaces/http/handler/product_test.go`

### Files modified
- `backend/cmd/server/main.go` - Route registration
- `backend/docs/swagger.yaml` - OpenAPI spec
- `backend/docs/swagger.json` - OpenAPI spec
- `backend/docs/docs.go` - Swagger embed

### Build Status
- `go build ./...` passes successfully
- `go test ./...` passes all tests (17 new handler tests)

### API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/catalog/products | Create a new product |
| GET | /api/v1/catalog/products | List products with filters |
| GET | /api/v1/catalog/products/:id | Get product by ID |
| GET | /api/v1/catalog/products/code/:code | Get product by code |
| PUT | /api/v1/catalog/products/:id | Update product |
| PUT | /api/v1/catalog/products/:id/code | Update product code |
| DELETE | /api/v1/catalog/products/:id | Delete product |
| PUT | /api/v1/catalog/products/:id/activate | Activate product |
| PUT | /api/v1/catalog/products/:id/deactivate | Deactivate product |
| PUT | /api/v1/catalog/products/:id/discontinue | Discontinue product |
| GET | /api/v1/catalog/products/count-by-status | Count products by status |
| GET | /api/v1/catalog/products/category/:category_id | Get products by category |

### Key Design Decisions
1. **X-Tenant-ID Header**: All endpoints require tenant ID via header for multi-tenancy
2. **Swagger Annotations**: Full OpenAPI 3.0 documentation for frontend SDK generation
3. **Error Handling**: Uses BaseHandler's error methods for consistent error responses
4. **Separation of DTOs**: Handler-level DTOs for Swagger, application-level DTOs for service

### Usage Examples
```bash
# Create product
curl -X POST http://localhost:8080/api/v1/catalog/products \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: 550e8400-e29b-41d4-a716-446655440000" \
  -d '{"code":"SKU-001","name":"Widget","unit":"pcs"}'

# List products with filters
curl "http://localhost:8080/api/v1/catalog/products?search=widget&status=active&page=1&page_size=20" \
  -H "X-Tenant-ID: 550e8400-e29b-41d4-a716-446655440000"

# Activate product
curl -X PUT http://localhost:8080/api/v1/catalog/products/123/activate \
  -H "X-Tenant-ID: 550e8400-e29b-41d4-a716-446655440000"
```

### Notes for next developer
- P1-FE-001 (Product List Page) can now be started - API is ready
- Run `npm run api:generate` in frontend to generate TypeScript SDK from updated OpenAPI spec
- All endpoints are documented in Swagger UI at /swagger/index.html
- Handler tests use mock repositories - integration tests will need real database

---

## 2026-01-24 - P1-FE-001: Product List Page Complete

### Completed
- **P1-FE-001**: 商品列表页面 (Product List Page)

### What was done
1. Regenerated TypeScript SDK from backend OpenAPI spec using `npm run api:generate`
2. Updated axios-instance.ts to include X-Tenant-ID header from user data in localStorage
3. Created comprehensive Product list page (`frontend/src/pages/catalog/Products.tsx`) with:
   - DataTable integration with full pagination and sorting
   - Search functionality (name, code, barcode)
   - Status filter dropdown (全部状态/启用/禁用/停售)
   - Row actions: view, edit, activate, deactivate, discontinue, delete
   - Bulk actions: batch activate/deactivate selected products
   - Confirmation modals for destructive actions (discontinue, delete)
   - Proper TypeScript types with DataTable compatibility
4. Created Products.css for product page styling
5. Fixed all TypeScript and ESLint errors

### Files created/modified
- `frontend/src/pages/catalog/Products.tsx` - Complete rewrite with full functionality
- `frontend/src/pages/catalog/Products.css` - New styling file
- `frontend/src/services/axios-instance.ts` - Added X-Tenant-ID header support
- `frontend/src/api/` - Regenerated SDK from backend OpenAPI spec

### Technical decisions
- Created intersection type `type Product = HandlerProductListResponse & Record<string, unknown>` for DataTable generic constraint compatibility
- Used callbacks with useCallback for all handlers to prevent unnecessary re-renders
- Status filter uses Semi Design Select component with consistent styling
- Bulk actions use Promise.all for parallel API calls

### Notes for next developer
- P1-FE-002 (Product Form) is the natural next step
- The product list page navigates to `/catalog/products/new` and `/catalog/products/:id/edit` which need to be implemented
- Product view page at `/catalog/products/:id` also needs implementation
- Consider adding category filter once P1-FE-003 (Category Management) is complete
- Build passes with expected chunk size warnings (vendor chunk ~693KB)

