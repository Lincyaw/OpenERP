# ERP Project Progress Log

## 2026-01-25 - P3-INT-001 Sales Order E2E Test Fixes

### Summary
Worked on fixing Sales Order E2E tests (P3-INT-001). Made multiple backend and frontend fixes to resolve data binding, status filtering, and optimistic locking issues.

### Files Modified

#### Backend
- `backend/internal/infrastructure/persistence/sales_order_repository.go`
  - Fixed status filtering to normalize to uppercase (database stores DRAFT, API receives draft)
  - Fixed optimistic locking version check in SaveWithLock (domain model increments version before save)

- `backend/internal/application/trade/dto.go`
  - Modified all order status responses to return lowercase (ToSalesOrderResponse, ToSalesOrderListItemResponse, etc.)

#### Frontend
- `frontend/src/features/trade/SalesOrderForm.tsx`
  - Fixed customer_name binding using Semi Design Select's onChangeWithObject prop
  - Changed from customers.find() lookup to direct option.label access

- `frontend/tests/e2e/transactions/sales-order.spec.ts`
  - Fixed warehouse name references to use TEST_DATA.warehouses.beijing.name instead of hardcoded 'Main Warehouse'

- `frontend/tests/e2e/pages/SalesOrderPage.ts`
  - Improved confirmOrder() timing with explicit wait for status tag update

### Bugs Fixed
1. customer_name not populated when creating sales order
   - Root cause: Semi Design Select onChange only provides value, not the full option object
   - Fix: Use onChangeWithObject to get both value and label

2. Status case sensitivity mismatch (DRAFT vs draft)
   - Root cause: Backend stores uppercase, frontend sends lowercase
   - Fix: Normalize to uppercase in repository filter, return lowercase in API responses

3. Optimistic locking version mismatch causing 500 error on confirm
   - Root cause: Domain model's Confirm() increments version, then SaveWithLock checked wrong version
   - Fix: Check currentVersion == order.Version - 1 instead of order.Version

4. Warehouse name mismatch in E2E tests
   - Root cause: Test used 'Main Warehouse' but seed data has Chinese name '北京主仓'
   - Fix: Use TEST_DATA constant for warehouse names

### Test Results
- TypeScript type check: PASSED
- E2E tests: 12/14 core scenarios passing
- Remaining issues: Complex multi-product order timing (E2E stability optimization)

### Next Steps
- P3-INT-001 core functionality is working
- Remaining timing issues are E2E test stability concerns, not core bugs

---

## 2026-01-26 - P3-INT-002 Purchase Order E2E Test Fix

### Summary
Implemented PurchaseOrderDetail page to fix the E2E test issues caused by Semi Design dropdown menu positioning in headless Chrome. The dropdown menu items were positioned outside the viewport in Docker/headless environments, causing 11 E2E tests to be skipped.

### Problem
- Semi Design Dropdown menu items positioned outside viewport in Docker/headless Chrome
- Affected: confirm, receive, cancel actions in table row dropdowns
- 11 E2E tests were skipped due to this issue

### Solution
Created a dedicated PurchaseOrderDetail page (similar to SalesOrderDetail) that provides direct action buttons instead of relying on dropdown menus in table rows. E2E tests can now navigate to the detail page and use the action buttons directly.

### Files Created

#### Frontend - New Files
- `frontend/src/pages/trade/PurchaseOrderDetail.tsx`
  - Main detail page component following SalesOrderDetail.tsx pattern
  - Features: order info display, items table with receive progress, status timeline
  - Action buttons: Edit (draft), Confirm (draft), Receive (confirmed), Cancel (draft/confirmed)

- `frontend/src/pages/trade/PurchaseOrderDetail.css`
  - Styles matching SalesOrderDetail.css pattern
  - Added receive-progress-section styling

### Files Modified

#### Frontend - Localization
- `frontend/src/locales/zh-CN/trade.json`
  - Added `purchaseOrderDetail` section with Chinese translations
  - Added `"unit": "种"` to purchaseOrder section

- `frontend/src/locales/en-US/trade.json`
  - Added matching English translations for purchaseOrderDetail

#### Frontend - Routing
- `frontend/src/router/routes.tsx`
  - Added lazy import for PurchaseOrderDetailPage
  - Added route: `{ path: 'purchase/:id', element: PurchaseOrderDetailPage() }`

### Test Results
- TypeScript type check: PASSED
- Build: PASSED

### Next Steps
- Update E2E tests to use detail page for confirm/receive/cancel actions
- Run full E2E test suite to verify fix
