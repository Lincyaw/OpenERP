# ERP Project Progress Log

## 2026-01-25 - P2-INT-002 盘点功能联调 (E2E Docker)

### Summary
Working on stock taking E2E tests. Improved pass rate from 68/116 to 73/116 (63%).
Chromium browser: 20/24 tests passing (83%).

### Issues Fixed

1. **Frontend decimal string handling** - Backend (Go) uses shopspring/decimal which serializes to JSON strings, but frontend expected numbers.
   - Fixed `formatQuantity()` to handle both number and string types
   - Fixed `calculateDifference()` to convert string decimals to numbers
   - Fixed `localTotals` useMemo to parse string quantities
   - Fixed `fetchStockTaking()` to parse string actual_quantity

2. **E2E test isolation** - Tests were failing because multiple browsers shared the same database.
   - Added `currentStockTakingNumber` property to InventoryPage class
   - Modified `waitForStockTakingCreateSuccess()` to capture and store taking number
   - Added `getCurrentStockTakingRow()` method for test isolation
   - Updated tests to use `getCurrentStockTakingRow()` instead of `getStockTakingRow(0)`

3. **Button click timing** - Fixed clickStartCounting, clickSaveAllCounts, clickSubmitForApproval methods.
   - Changed from using `isVisible()` to `waitFor()` since isVisible doesn't wait
   - Added enabled checks before clicking buttons
   - Added `toBeEnabled()` assertions with timeouts

### Files Modified
- `frontend/src/pages/inventory/StockTakingExecute.tsx`
- `frontend/tests/e2e/pages/InventoryPage.ts`
- `frontend/tests/e2e/inventory/stock-taking.spec.ts`
- `.claude/ralph/plans/prd.json`

### Remaining Issues
- 43 tests still failing across all browsers (primarily webkit, mobile-chrome, mobile-safari)
- Stock Taking Execution tests have timing issues with button states
- Stock Taking with Differences tests need verification
- Video Recording tests need completion

### Next Steps
- Further investigate button state timing in webkit/mobile browsers
- Consider adding more explicit waits for API responses
- May need to serialize some tests that modify shared data
