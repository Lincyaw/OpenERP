name: Backend CI

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/backend.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'backend/**'
      - '.github/workflows/backend.yml'

defaults:
  run:
    working-directory: backend

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: backend/go.sum

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Code is not formatted. Run 'make fmt'"
            gofmt -l .
            exit 1
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: erp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: backend/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: make test-unit

      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          go test -short -coverprofile=coverage/coverage.out -covermode=atomic ./...

      - name: Check coverage threshold (80%)
        run: |
          COVERAGE=$(go tool cover -func=coverage/coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          if [ $(echo "${COVERAGE} < 80" | bc -l) -eq 1 ]; then
            echo "ERROR: Coverage ${COVERAGE}% is below threshold 80%"
            exit 1
          else
            echo "OK: Coverage ${COVERAGE}% meets threshold 80%"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage/coverage.out

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: backend/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests
        run: make test-integration

  docs:
    name: OpenAPI Docs Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: backend/go.sum

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@v2.0.0

      - name: Check OpenAPI docs are up-to-date
        run: |
          mkdir -p /tmp/docs-check
          cp docs/swagger.yaml /tmp/docs-check/swagger.yaml.old 2>/dev/null || true
          swag init -g cmd/server/main.go -o /tmp/docs-check --outputTypes yaml
          if ! diff -q docs/swagger.yaml /tmp/docs-check/swagger.yaml > /dev/null 2>&1; then
            echo "ERROR: OpenAPI docs are out of date. Run 'make docs' to regenerate."
            exit 1
          fi
          echo "OK: OpenAPI docs are up-to-date."

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache-dependency-path: backend/go.sum

      - name: Build binary
        run: make build

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/bin/erp-server
